\hypertarget{s2n__async__pkey_8h_source}{}\doxysection{s2n\+\_\+async\+\_\+pkey.\+h}
\label{s2n__async__pkey_8h_source}\index{crt/aws-\/crt-\/cpp/crt/s2n/tls/s2n\_async\_pkey.h@{crt/aws-\/crt-\/cpp/crt/s2n/tls/s2n\_async\_pkey.h}}
\mbox{\hyperlink{s2n__async__pkey_8h}{Go to the documentation of this file.}}
\begin{DoxyCode}{0}
\DoxyCodeLine{1 \textcolor{comment}{/*}}
\DoxyCodeLine{2 \textcolor{comment}{ * Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.}}
\DoxyCodeLine{3 \textcolor{comment}{ *}}
\DoxyCodeLine{4 \textcolor{comment}{ * Licensed under the Apache License, Version 2.0 (the "{}License"{}).}}
\DoxyCodeLine{5 \textcolor{comment}{ * You may not use this file except in compliance with the License.}}
\DoxyCodeLine{6 \textcolor{comment}{ * A copy of the License is located at}}
\DoxyCodeLine{7 \textcolor{comment}{ *}}
\DoxyCodeLine{8 \textcolor{comment}{ *  http://aws.amazon.com/apache2.0}}
\DoxyCodeLine{9 \textcolor{comment}{ *}}
\DoxyCodeLine{10 \textcolor{comment}{ * or in the "{}license"{} file accompanying this file. This file is distributed}}
\DoxyCodeLine{11 \textcolor{comment}{ * on an "{}AS IS"{} BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either}}
\DoxyCodeLine{12 \textcolor{comment}{ * express or implied. See the License for the specific language governing}}
\DoxyCodeLine{13 \textcolor{comment}{ * permissions and limitations under the License.}}
\DoxyCodeLine{14 \textcolor{comment}{ */}}
\DoxyCodeLine{15 }
\DoxyCodeLine{16 \textcolor{preprocessor}{\#pragma once}}
\DoxyCodeLine{17 }
\DoxyCodeLine{18 \textcolor{preprocessor}{\#include "{}\mbox{\hyperlink{s2n__connection_8h}{tls/s2n\_connection.h}}"{}}}
\DoxyCodeLine{19 \textcolor{preprocessor}{\#include "{}utils/s2n\_blob.h"{}}}
\DoxyCodeLine{20 \textcolor{preprocessor}{\#include "{}utils/s2n\_result.h"{}}}
\DoxyCodeLine{21 }
\DoxyCodeLine{22 \textcolor{keyword}{typedef} int (*\mbox{\hyperlink{s2n__async__pkey_8h_ab0ae41ea1fe8196572d6131efc73939f}{s2n\_async\_pkey\_sign\_complete}})(\textcolor{keyword}{struct }\mbox{\hyperlink{structs2n__connection}{s2n\_connection}} *conn, \textcolor{keyword}{struct }s2n\_blob *signature);}
\DoxyCodeLine{23 \textcolor{keyword}{typedef} int (*\mbox{\hyperlink{s2n__async__pkey_8h_aed227739da6e57341c0d04484879d0e7}{s2n\_async\_pkey\_decrypt\_complete}})(\textcolor{keyword}{struct }\mbox{\hyperlink{structs2n__connection}{s2n\_connection}} *conn, \textcolor{keywordtype}{bool} rsa\_failed, \textcolor{keyword}{struct }s2n\_blob *decrypted);}
\DoxyCodeLine{24 }
\DoxyCodeLine{25 \textcolor{keyword}{struct }\mbox{\hyperlink{structs2n__async__pkey__op}{s2n\_async\_pkey\_op}};}
\DoxyCodeLine{26 }
\DoxyCodeLine{27 \textcolor{comment}{/* Guard to handle async states inside handler which uses async pkey operations. If async operation was not invoked}}
\DoxyCodeLine{28 \textcolor{comment}{ * it means that we enter this handler for the first time and handler may or may not use async operation, so we let it}}
\DoxyCodeLine{29 \textcolor{comment}{ * continue. If async operation is invoking or was invoked, but yet to be complete, we error out of the handler to let}}
\DoxyCodeLine{30 \textcolor{comment}{ * s2n\_handle\_retry\_state try again. If async operation was complete we clear the state and let s2n\_handle\_retry\_state}}
\DoxyCodeLine{31 \textcolor{comment}{ * proceed to the next handler */}}
\DoxyCodeLine{32 \textcolor{preprocessor}{\#define S2N\_ASYNC\_PKEY\_GUARD(conn)                                         \(\backslash\)}}
\DoxyCodeLine{33 \textcolor{preprocessor}{    do \{                                                                   \(\backslash\)}}
\DoxyCodeLine{34 \textcolor{preprocessor}{        \_\_typeof(conn) \_\_tmp\_conn = (conn);                                \(\backslash\)}}
\DoxyCodeLine{35 \textcolor{preprocessor}{        GUARD\_NONNULL(\_\_tmp\_conn);                                         \(\backslash\)}}
\DoxyCodeLine{36 \textcolor{preprocessor}{        switch (conn-\/>handshake.async\_state) \{                             \(\backslash\)}}
\DoxyCodeLine{37 \textcolor{preprocessor}{            case S2N\_ASYNC\_NOT\_INVOKED:                                    \(\backslash\)}}
\DoxyCodeLine{38 \textcolor{preprocessor}{                break;                                                     \(\backslash\)}}
\DoxyCodeLine{39 \textcolor{preprocessor}{                                                                           \(\backslash\)}}
\DoxyCodeLine{40 \textcolor{preprocessor}{            case S2N\_ASYNC\_INVOKING\_CALLBACK:                              \(\backslash\)}}
\DoxyCodeLine{41 \textcolor{preprocessor}{            case S2N\_ASYNC\_INVOKED\_WAITING:                                \(\backslash\)}}
\DoxyCodeLine{42 \textcolor{preprocessor}{                BAIL\_POSIX(S2N\_ERR\_ASYNC\_BLOCKED);                         \(\backslash\)}}
\DoxyCodeLine{43 \textcolor{preprocessor}{                                                                           \(\backslash\)}}
\DoxyCodeLine{44 \textcolor{preprocessor}{            case S2N\_ASYNC\_INVOKED\_COMPLETE:                               \(\backslash\)}}
\DoxyCodeLine{45 \textcolor{preprocessor}{                }\textcolor{comment}{/* clean up state and return a success from handler */}\textcolor{preprocessor}{     \(\backslash\)}}
\DoxyCodeLine{46 \textcolor{preprocessor}{                \_\_tmp\_conn-\/>handshake.async\_state = S2N\_ASYNC\_NOT\_INVOKED; \(\backslash\)}}
\DoxyCodeLine{47 \textcolor{preprocessor}{                GUARD(s2n\_conn\_clear\_handshake\_read\_block(\_\_tmp\_conn));    \(\backslash\)}}
\DoxyCodeLine{48 \textcolor{preprocessor}{                return S2N\_SUCCESS;                                        \(\backslash\)}}
\DoxyCodeLine{49 \textcolor{preprocessor}{        \}                                                                  \(\backslash\)}}
\DoxyCodeLine{50 \textcolor{preprocessor}{    \} while (0)}}
\DoxyCodeLine{51 }
\DoxyCodeLine{52 \textcolor{comment}{/* Macros for safe exection of async sign/decrypt.}}
\DoxyCodeLine{53 \textcolor{comment}{ *}}
\DoxyCodeLine{54 \textcolor{comment}{ * When operation is done asynchronously, we drop to s2n\_negotiate loop with S2N\_ERR\_ASYNC\_BLOCKED error and do not}}
\DoxyCodeLine{55 \textcolor{comment}{ * perform any of the operations to follow after s2n\_async* call. To enforce that there are no operations after the}}
\DoxyCodeLine{56 \textcolor{comment}{ * call, we use a macro which directly returns the result of s2n\_async* operation forcing compiler to error out on}}
\DoxyCodeLine{57 \textcolor{comment}{ * unreachable code and forcing developer to use on\_complete function instead */}}
\DoxyCodeLine{58 \textcolor{preprocessor}{\#define S2N\_ASYNC\_PKEY\_DECRYPT(conn, encrypted, init\_decrypted, on\_complete) \(\backslash\)}}
\DoxyCodeLine{59 \textcolor{preprocessor}{    return S2N\_RESULT\_TO\_POSIX(s2n\_async\_pkey\_decrypt(conn, encrypted, init\_decrypted, on\_complete));}}
\DoxyCodeLine{60 }
\DoxyCodeLine{61 \textcolor{preprocessor}{\#define S2N\_ASYNC\_PKEY\_SIGN(conn, sig\_alg, digest, on\_complete) \(\backslash\)}}
\DoxyCodeLine{62 \textcolor{preprocessor}{    return S2N\_RESULT\_TO\_POSIX(s2n\_async\_pkey\_sign(conn, sig\_alg, digest, on\_complete));}}
\DoxyCodeLine{63 }
\DoxyCodeLine{64 \textcolor{keywordtype}{int} \mbox{\hyperlink{s2n__async__pkey_8h_a47687920829578eb45be9a47c826490d}{s2n\_async\_pkey\_op\_perform}}(\textcolor{keyword}{struct} \mbox{\hyperlink{structs2n__async__pkey__op}{s2n\_async\_pkey\_op}} *\mbox{\hyperlink{structs2n__async__pkey__op_ae63bff330b37a07b1f06f9d121148392}{op}}, \mbox{\hyperlink{structs2n__pkey}{s2n\_cert\_private\_key}} *key);}
\DoxyCodeLine{65 \textcolor{keywordtype}{int} \mbox{\hyperlink{s2n__async__pkey_8h_ad144bdf2d201c8a8c032563251545cbf}{s2n\_async\_pkey\_op\_apply}}(\textcolor{keyword}{struct} \mbox{\hyperlink{structs2n__async__pkey__op}{s2n\_async\_pkey\_op}} *\mbox{\hyperlink{structs2n__async__pkey__op_ae63bff330b37a07b1f06f9d121148392}{op}}, \textcolor{keyword}{struct} \mbox{\hyperlink{structs2n__connection}{s2n\_connection}} *\mbox{\hyperlink{structs2n__async__pkey__op_acd558153c69d882e9ae27cd3b19fd31a}{conn}});}
\DoxyCodeLine{66 \textcolor{keywordtype}{int} \mbox{\hyperlink{s2n__async__pkey_8h_a1b0969d5027ec527296b0be240c8f440}{s2n\_async\_pkey\_op\_free}}(\textcolor{keyword}{struct} \mbox{\hyperlink{structs2n__async__pkey__op}{s2n\_async\_pkey\_op}} *\mbox{\hyperlink{structs2n__async__pkey__op_ae63bff330b37a07b1f06f9d121148392}{op}});}
\DoxyCodeLine{67 }
\DoxyCodeLine{68 S2N\_RESULT \mbox{\hyperlink{s2n__async__pkey_8h_af67b5746aa73664a39f925afae45f2b9}{s2n\_async\_pkey\_decrypt}}(\textcolor{keyword}{struct} \mbox{\hyperlink{structs2n__connection}{s2n\_connection}} *\mbox{\hyperlink{structs2n__async__pkey__op_acd558153c69d882e9ae27cd3b19fd31a}{conn}}, \textcolor{keyword}{struct} s2n\_blob *encrypted, \textcolor{keyword}{struct} s2n\_blob *init\_decrypted,}
\DoxyCodeLine{69                            \mbox{\hyperlink{s2n__async__pkey_8h_aed227739da6e57341c0d04484879d0e7}{s2n\_async\_pkey\_decrypt\_complete}} on\_complete);}
\DoxyCodeLine{70 S2N\_RESULT \mbox{\hyperlink{s2n__async__pkey_8h_a40030bf55355d66a65892e5c4af6ff05}{s2n\_async\_pkey\_sign}}(\textcolor{keyword}{struct} \mbox{\hyperlink{structs2n__connection}{s2n\_connection}} *\mbox{\hyperlink{structs2n__async__pkey__op_acd558153c69d882e9ae27cd3b19fd31a}{conn}}, \mbox{\hyperlink{s2n__signature_8h_a28050d82b8dc7de14b8b0698eb526780}{s2n\_signature\_algorithm}} sig\_alg, \textcolor{keyword}{struct} \mbox{\hyperlink{structs2n__hash__state}{s2n\_hash\_state}} *digest,}
\DoxyCodeLine{71                         \mbox{\hyperlink{s2n__async__pkey_8h_ab0ae41ea1fe8196572d6131efc73939f}{s2n\_async\_pkey\_sign\_complete}} on\_complete);}

\end{DoxyCode}
