\hypertarget{h1__connection_8h_source}{}\doxysection{h1\+\_\+connection.\+h}
\label{h1__connection_8h_source}\index{crt/aws-\/crt-\/cpp/crt/aws-\/c-\/http/include/aws/http/private/h1\_connection.h@{crt/aws-\/crt-\/cpp/crt/aws-\/c-\/http/include/aws/http/private/h1\_connection.h}}
\mbox{\hyperlink{h1__connection_8h}{Go to the documentation of this file.}}
\begin{DoxyCode}{0}
\DoxyCodeLine{1 \textcolor{preprocessor}{\#ifndef AWS\_HTTP\_H1\_CONNECTION\_H}}
\DoxyCodeLine{2 \textcolor{preprocessor}{\#define AWS\_HTTP\_H1\_CONNECTION\_H}}
\DoxyCodeLine{3 }
\DoxyCodeLine{9 \textcolor{preprocessor}{\#include <\mbox{\hyperlink{mutex_8h}{aws/common/mutex.h}}>}}
\DoxyCodeLine{10 \textcolor{preprocessor}{\#include <\mbox{\hyperlink{connection__impl_8h}{aws/http/private/connection\_impl.h}}>}}
\DoxyCodeLine{11 \textcolor{preprocessor}{\#include <\mbox{\hyperlink{h1__encoder_8h}{aws/http/private/h1\_encoder.h}}>}}
\DoxyCodeLine{12 \textcolor{preprocessor}{\#include <\mbox{\hyperlink{aws-c-http_2include_2aws_2http_2statistics_8h}{aws/http/statistics.h}}>}}
\DoxyCodeLine{13 }
\DoxyCodeLine{14 \textcolor{preprocessor}{\#ifdef \_MSC\_VER}}
\DoxyCodeLine{15 \textcolor{preprocessor}{\#    pragma warning(disable : 4214) }\textcolor{comment}{/* nonstandard extension used: bit field types other than int */}\textcolor{preprocessor}{}}
\DoxyCodeLine{16 \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{17 }
\DoxyCodeLine{18 \textcolor{keyword}{struct }\mbox{\hyperlink{structaws__h1__connection}{aws\_h1\_connection}} \{}
\DoxyCodeLine{19     \textcolor{keyword}{struct }\mbox{\hyperlink{structaws__http__connection}{aws\_http\_connection}} \mbox{\hyperlink{structaws__h1__connection_af556f751039db2bb6c688945502e81d9}{base}};}
\DoxyCodeLine{20 }
\DoxyCodeLine{21     \textcolor{keywordtype}{size\_t} \mbox{\hyperlink{structaws__h1__connection_ae924c5d104fbcea48ffdb24cda4c3528}{initial\_stream\_window\_size}};}
\DoxyCodeLine{22 }
\DoxyCodeLine{23     \textcolor{comment}{/* Task responsible for sending data.}}
\DoxyCodeLine{24 \textcolor{comment}{     * As long as there is data available to send, the task will be "{}active"{} and repeatedly:}}
\DoxyCodeLine{25 \textcolor{comment}{     * 1) Encode outgoing stream data to an aws\_io\_message and send it up the channel.}}
\DoxyCodeLine{26 \textcolor{comment}{     * 2) Wait until the aws\_io\_message's write\_complete callback fires.}}
\DoxyCodeLine{27 \textcolor{comment}{     * 3) Reschedule the task to run again.}}
\DoxyCodeLine{28 \textcolor{comment}{     *}}
\DoxyCodeLine{29 \textcolor{comment}{     * `thread\_data.is\_outgoing\_stream\_task\_active` tells whether the task is "{}active"{}.}}
\DoxyCodeLine{30 \textcolor{comment}{     *}}
\DoxyCodeLine{31 \textcolor{comment}{     * If there is no data available to write (waiting for user to add more streams or chunks),}}
\DoxyCodeLine{32 \textcolor{comment}{     * then the task stops being active. The task is made active again when the user}}
\DoxyCodeLine{33 \textcolor{comment}{     * adds more outgoing data. */}}
\DoxyCodeLine{34     \textcolor{keyword}{struct }\mbox{\hyperlink{structaws__channel__task}{aws\_channel\_task}} \mbox{\hyperlink{structaws__h1__connection_ad31c66bb46479c87f81fd0265e0a1be4}{outgoing\_stream\_task}};}
\DoxyCodeLine{35 }
\DoxyCodeLine{36     \textcolor{comment}{/* Task that removes items from `synced\_data` and does their on-\/thread work.}}
\DoxyCodeLine{37 \textcolor{comment}{     * Runs once and wait until it's scheduled again.}}
\DoxyCodeLine{38 \textcolor{comment}{     * Any function that wants to schedule this task MUST:}}
\DoxyCodeLine{39 \textcolor{comment}{     * -\/ acquire the synced\_data.lock}}
\DoxyCodeLine{40 \textcolor{comment}{     * -\/ check whether `synced\_data.is\_cross\_thread\_work\_scheduled` was true or false.}}
\DoxyCodeLine{41 \textcolor{comment}{     * -\/ set `synced\_data.is\_cross\_thread\_work\_scheduled = true`}}
\DoxyCodeLine{42 \textcolor{comment}{     * -\/ release synced\_data.lock}}
\DoxyCodeLine{43 \textcolor{comment}{     * -\/ ONLY IF `synced\_data.is\_cross\_thread\_work\_scheduled` CHANGED from false to true:}}
\DoxyCodeLine{44 \textcolor{comment}{     *   -\/ then schedule the task}}
\DoxyCodeLine{45 \textcolor{comment}{     */}}
\DoxyCodeLine{46     \textcolor{keyword}{struct }\mbox{\hyperlink{structaws__channel__task}{aws\_channel\_task}} \mbox{\hyperlink{structaws__h1__connection_a47657ff5517ce13f432bbe93aa03e9fe}{cross\_thread\_work\_task}};}
\DoxyCodeLine{47 }
\DoxyCodeLine{48     \textcolor{comment}{/* Only the event-\/loop thread may touch this data */}}
\DoxyCodeLine{49     \textcolor{keyword}{struct }\{}
\DoxyCodeLine{50         \textcolor{comment}{/* List of streams being worked on. */}}
\DoxyCodeLine{51         \textcolor{keyword}{struct }\mbox{\hyperlink{structaws__linked__list}{aws\_linked\_list}} \mbox{\hyperlink{structaws__h1__connection_a2eaf9722a8f44fd67e9c5797a49d2c5d}{stream\_list}};}
\DoxyCodeLine{52 }
\DoxyCodeLine{53         \textcolor{comment}{/* Points to the stream whose data is currently being sent.}}
\DoxyCodeLine{54 \textcolor{comment}{         * This stream is ALWAYS in the `stream\_list`.}}
\DoxyCodeLine{55 \textcolor{comment}{         * HTTP pipelining is supported, so once the stream is completely written}}
\DoxyCodeLine{56 \textcolor{comment}{         * we'll start working on the next stream in the list */}}
\DoxyCodeLine{57         \textcolor{keyword}{struct }\mbox{\hyperlink{structaws__h1__stream}{aws\_h1\_stream}} *\mbox{\hyperlink{structaws__h1__connection_a99ad203911e8ffd4d9fc0937d8036d9e}{outgoing\_stream}};}
\DoxyCodeLine{58 }
\DoxyCodeLine{59         \textcolor{comment}{/* Points to the stream being decoded.}}
\DoxyCodeLine{60 \textcolor{comment}{         * This stream is ALWAYS in the `stream\_list`. */}}
\DoxyCodeLine{61         \textcolor{keyword}{struct }\mbox{\hyperlink{structaws__h1__stream}{aws\_h1\_stream}} *\mbox{\hyperlink{structaws__h1__connection_a6f8ce16d2ca30619b16a120eca787641}{incoming\_stream}};}
\DoxyCodeLine{62         \textcolor{keyword}{struct }\mbox{\hyperlink{structaws__h1__decoder}{aws\_h1\_decoder}} *\mbox{\hyperlink{structaws__h1__connection_ad6e43e0ffb8f309012850b0c7e4d259e}{incoming\_stream\_decoder}};}
\DoxyCodeLine{63 }
\DoxyCodeLine{64         \textcolor{comment}{/* Used to encode requests and responses */}}
\DoxyCodeLine{65         \textcolor{keyword}{struct }\mbox{\hyperlink{structaws__h1__encoder}{aws\_h1\_encoder}} \mbox{\hyperlink{structaws__h1__connection_ab41e53bd4ca65385872c73d93de2b1ba}{encoder}};}
\DoxyCodeLine{66 }
\DoxyCodeLine{76         \textcolor{keyword}{struct }\{}
\DoxyCodeLine{77             \textcolor{keyword}{struct }\mbox{\hyperlink{structaws__linked__list}{aws\_linked\_list}} \mbox{\hyperlink{structaws__h1__connection_a838e9efbe429c10c8d7b791b122c8330}{messages}};}
\DoxyCodeLine{78             \textcolor{keywordtype}{size\_t} \mbox{\hyperlink{structaws__h1__connection_a5db62b6700201f261a0facff1d64e02d}{pending\_bytes}};}
\DoxyCodeLine{79             \textcolor{keywordtype}{size\_t} \mbox{\hyperlink{structaws__h1__connection_a14e619a2799de2bf0893458983a2474b}{capacity}};}
\DoxyCodeLine{80         \} \mbox{\hyperlink{structaws__h1__connection_a7ef089b87c2d084d751dcb87df8098a2}{read\_buffer}};}
\DoxyCodeLine{81 }
\DoxyCodeLine{89         \textcolor{keywordtype}{size\_t} \mbox{\hyperlink{structaws__h1__connection_af7447ac23cd5dca53c6245aa178c7a44}{connection\_window}};}
\DoxyCodeLine{90 }
\DoxyCodeLine{91         \textcolor{comment}{/* Only used by tests. Sum of window\_increments issued by this slot. Resets each time it's queried */}}
\DoxyCodeLine{92         \textcolor{keywordtype}{size\_t} \mbox{\hyperlink{structaws__h1__connection_aa74fba6213d403353016d172a236d5b2}{recent\_window\_increments}};}
\DoxyCodeLine{93 }
\DoxyCodeLine{94         \textcolor{keyword}{struct }\mbox{\hyperlink{structaws__crt__statistics__http1__channel}{aws\_crt\_statistics\_http1\_channel}} \mbox{\hyperlink{structaws__h1__connection_a426e6d2f5113cd840ede26bebf74c410}{stats}};}
\DoxyCodeLine{95 }
\DoxyCodeLine{96         uint64\_t \mbox{\hyperlink{structaws__h1__connection_a0e76b83ce23c80bab72a2c862ad94d71}{outgoing\_stream\_timestamp\_ns}};}
\DoxyCodeLine{97         uint64\_t \mbox{\hyperlink{structaws__h1__connection_a1d824af4c1576c1aaa8e089968192995}{incoming\_stream\_timestamp\_ns}};}
\DoxyCodeLine{98 }
\DoxyCodeLine{99         \textcolor{comment}{/* True when read and/or writing has stopped, whether due to errors or normal channel shutdown. */}}
\DoxyCodeLine{100         \textcolor{keywordtype}{bool} \mbox{\hyperlink{structaws__h1__connection_a29d87d449635e37824dcc4f7d289de80}{is\_reading\_stopped}} : 1;}
\DoxyCodeLine{101         \textcolor{keywordtype}{bool} \mbox{\hyperlink{structaws__h1__connection_ae5814dc9638bdc1fdcef88b7856f1890}{is\_writing\_stopped}} : 1;}
\DoxyCodeLine{102 }
\DoxyCodeLine{103         \textcolor{comment}{/* If true, the connection has upgraded to another protocol.}}
\DoxyCodeLine{104 \textcolor{comment}{         * It will pass data to adjacent channel handlers without altering it.}}
\DoxyCodeLine{105 \textcolor{comment}{         * The connection can no longer service request/response streams. */}}
\DoxyCodeLine{106         \textcolor{keywordtype}{bool} \mbox{\hyperlink{structaws__h1__connection_a1e8e23216c614aace73d5aed5b48e158}{has\_switched\_protocols}} : 1;}
\DoxyCodeLine{107 }
\DoxyCodeLine{108         \textcolor{comment}{/* Server-\/only. Request-\/handler streams can only be created while this is true. */}}
\DoxyCodeLine{109         \textcolor{keywordtype}{bool} \mbox{\hyperlink{structaws__h1__connection_ad3e0ed7c5ca0a2fe9b6b78887055382d}{can\_create\_request\_handler\_stream}} : 1;}
\DoxyCodeLine{110 }
\DoxyCodeLine{111         \textcolor{comment}{/* see `outgoing\_stream\_task` */}}
\DoxyCodeLine{112         \textcolor{keywordtype}{bool} \mbox{\hyperlink{structaws__h1__connection_a2f21c8d3824a38bf976c08c5aa937373}{is\_outgoing\_stream\_task\_active}} : 1;}
\DoxyCodeLine{113 }
\DoxyCodeLine{114         \textcolor{keywordtype}{bool} \mbox{\hyperlink{structaws__h1__connection_a7cc70504544f6d3191bcfe03de4e614f}{is\_processing\_read\_messages}} : 1;}
\DoxyCodeLine{115     \} \mbox{\hyperlink{structaws__h1__connection_a35eec3bace7433768e76fe6bbbe7a5ef}{thread\_data}};}
\DoxyCodeLine{116 }
\DoxyCodeLine{117     \textcolor{comment}{/* Any thread may touch this data, but the lock must be held */}}
\DoxyCodeLine{118     \textcolor{keyword}{struct }\{}
\DoxyCodeLine{119         \textcolor{keyword}{struct }\mbox{\hyperlink{structaws__mutex}{aws\_mutex}} \mbox{\hyperlink{structaws__h1__connection_a054ad12a5bbcba2883f9672c0235873e}{lock}};}
\DoxyCodeLine{120 }
\DoxyCodeLine{121         \textcolor{comment}{/* New client streams that have not been moved to `stream\_list` yet.}}
\DoxyCodeLine{122 \textcolor{comment}{         * This list is not used on servers. */}}
\DoxyCodeLine{123         \textcolor{keyword}{struct }\mbox{\hyperlink{structaws__linked__list}{aws\_linked\_list}} \mbox{\hyperlink{structaws__h1__connection_af59379fe58a0509c4e2ba0ae18a6c9c5}{new\_client\_stream\_list}};}
\DoxyCodeLine{124 }
\DoxyCodeLine{125         \textcolor{comment}{/* If non-\/zero, then window\_update\_task is scheduled */}}
\DoxyCodeLine{126         \textcolor{keywordtype}{size\_t} \mbox{\hyperlink{structaws__h1__connection_af793e47e2452c2415168760108f911ed}{window\_update\_size}};}
\DoxyCodeLine{127 }
\DoxyCodeLine{128         \textcolor{comment}{/* If non-\/zero, reason to immediately reject new streams. (ex: closing) */}}
\DoxyCodeLine{129         \textcolor{keywordtype}{int} \mbox{\hyperlink{structaws__h1__connection_a106b8e6cac74e8273270f78e54561b5d}{new\_stream\_error\_code}};}
\DoxyCodeLine{130 }
\DoxyCodeLine{131         \textcolor{comment}{/* See `cross\_thread\_work\_task` */}}
\DoxyCodeLine{132         \textcolor{keywordtype}{bool} \mbox{\hyperlink{structaws__h1__connection_afcc177409ef329edd235fe20cf001d95}{is\_cross\_thread\_work\_task\_scheduled}} : 1;}
\DoxyCodeLine{133 }
\DoxyCodeLine{134         \textcolor{comment}{/* For checking status from outside the event-\/loop thread. */}}
\DoxyCodeLine{135         \textcolor{keywordtype}{bool} \mbox{\hyperlink{structaws__h1__connection_adf359a7bbe3610b66eed0d2fc2f0952d}{is\_open}} : 1;}
\DoxyCodeLine{136 }
\DoxyCodeLine{137     \} \mbox{\hyperlink{structaws__h1__connection_adfe8d514edf00493aabe80888c0a0d92}{synced\_data}};}
\DoxyCodeLine{138 \};}
\DoxyCodeLine{139 }
\DoxyCodeLine{140 \textcolor{comment}{/* Allow tests to check current window stats */}}
\DoxyCodeLine{141 \textcolor{keyword}{struct }\mbox{\hyperlink{structaws__h1__window__stats}{aws\_h1\_window\_stats}} \{}
\DoxyCodeLine{142     \textcolor{keywordtype}{size\_t} \mbox{\hyperlink{structaws__h1__window__stats_a08a231d20f8fdcfec71694a8a8c70d95}{connection\_window}};}
\DoxyCodeLine{143     \textcolor{keywordtype}{size\_t} \mbox{\hyperlink{structaws__h1__window__stats_ab86be17126f6ab6644c43a41c9e7ef64}{recent\_window\_increments}}; \textcolor{comment}{/* Resets to 0 each time window stats are queried*/}}
\DoxyCodeLine{144     \textcolor{keywordtype}{size\_t} \mbox{\hyperlink{structaws__h1__window__stats_a948eccb50f637b892413f2dbae7d18a7}{buffer\_capacity}};}
\DoxyCodeLine{145     \textcolor{keywordtype}{size\_t} \mbox{\hyperlink{structaws__h1__window__stats_ae453df86a4c4973e66078a4996ee3508}{buffer\_pending\_bytes}};}
\DoxyCodeLine{146     uint64\_t \mbox{\hyperlink{structaws__h1__window__stats_a0f49bbb4590a6ea6ef16eb459a669584}{stream\_window}};}
\DoxyCodeLine{147     \textcolor{keywordtype}{bool} \mbox{\hyperlink{structaws__h1__window__stats_af01a6f1c739af516c63596948d711b1b}{has\_incoming\_stream}};}
\DoxyCodeLine{148 \};}
\DoxyCodeLine{149 }
\DoxyCodeLine{150 \mbox{\hyperlink{macros_8h_ab6f66af8231eba5da061b9ada0d29bad}{AWS\_EXTERN\_C\_BEGIN}}}
\DoxyCodeLine{151 }
\DoxyCodeLine{152 \textcolor{comment}{/* The functions below are exported so they can be accessed from tests. */}}
\DoxyCodeLine{153 }
\DoxyCodeLine{154 \mbox{\hyperlink{crt_2aws-crt-cpp_2crt_2aws-c-http_2include_2aws_2http_2_exports_8h_a8eba90dca01a9989cacc0060fa84122a}{AWS\_HTTP\_API}}}
\DoxyCodeLine{155 \textcolor{keyword}{struct }\mbox{\hyperlink{structaws__http__connection}{aws\_http\_connection}} *\mbox{\hyperlink{h1__connection_8h_af8e94e4b50d614f906924b69487389ba}{aws\_http\_connection\_new\_http1\_1\_server}}(}
\DoxyCodeLine{156     \textcolor{keyword}{struct} \mbox{\hyperlink{structaws__allocator}{aws\_allocator}} *\mbox{\hyperlink{socket__test_8c_a130cc941753892421e3f70bdee1049d1}{allocator}},}
\DoxyCodeLine{157     \textcolor{keywordtype}{bool} \mbox{\hyperlink{structaws__http__connection_a94d687437ce0bddb27df2da83db2b646}{manual\_window\_management}},}
\DoxyCodeLine{158     \textcolor{keywordtype}{size\_t} initial\_window\_size,}
\DoxyCodeLine{159     \textcolor{keyword}{const} \textcolor{keyword}{struct} \mbox{\hyperlink{structaws__http1__connection__options}{aws\_http1\_connection\_options}} *http1\_options);}
\DoxyCodeLine{160 }
\DoxyCodeLine{161 \mbox{\hyperlink{crt_2aws-crt-cpp_2crt_2aws-c-http_2include_2aws_2http_2_exports_8h_a8eba90dca01a9989cacc0060fa84122a}{AWS\_HTTP\_API}}}
\DoxyCodeLine{162 \textcolor{keyword}{struct }\mbox{\hyperlink{structaws__http__connection}{aws\_http\_connection}} *\mbox{\hyperlink{h1__connection_8h_ab722b955ed4ec4fd8a1ca2fbfe2d9d5b}{aws\_http\_connection\_new\_http1\_1\_client}}(}
\DoxyCodeLine{163     \textcolor{keyword}{struct} \mbox{\hyperlink{structaws__allocator}{aws\_allocator}} *\mbox{\hyperlink{socket__test_8c_a130cc941753892421e3f70bdee1049d1}{allocator}},}
\DoxyCodeLine{164     \textcolor{keywordtype}{bool} \mbox{\hyperlink{structaws__http__connection_a94d687437ce0bddb27df2da83db2b646}{manual\_window\_management}},}
\DoxyCodeLine{165     \textcolor{keywordtype}{size\_t} initial\_window\_size,}
\DoxyCodeLine{166     \textcolor{keyword}{const} \textcolor{keyword}{struct} \mbox{\hyperlink{structaws__http1__connection__options}{aws\_http1\_connection\_options}} *http1\_options);}
\DoxyCodeLine{167 }
\DoxyCodeLine{168 \textcolor{comment}{/* Allow tests to check current window stats */}}
\DoxyCodeLine{169 \mbox{\hyperlink{crt_2aws-crt-cpp_2crt_2aws-c-http_2include_2aws_2http_2_exports_8h_a8eba90dca01a9989cacc0060fa84122a}{AWS\_HTTP\_API}}}
\DoxyCodeLine{170 \textcolor{keyword}{struct }\mbox{\hyperlink{structaws__h1__window__stats}{aws\_h1\_window\_stats}} \mbox{\hyperlink{h1__connection_8h_adf6859ca63c0e930fa21537a2d734209}{aws\_h1\_connection\_window\_stats}}(struct \mbox{\hyperlink{structaws__http__connection}{aws\_http\_connection}} *connection\_base);}
\DoxyCodeLine{171 }
\DoxyCodeLine{172 \mbox{\hyperlink{macros_8h_a24efb76a3b128abc9c35d83cac0030c5}{AWS\_EXTERN\_C\_END}}}
\DoxyCodeLine{173 }
\DoxyCodeLine{174 \textcolor{comment}{/* DO NOT export functions below. They're only used by other .c files in this library */}}
\DoxyCodeLine{175 }
\DoxyCodeLine{176 \textcolor{comment}{/* TODO: introduce naming conventions for private header functions */}}
\DoxyCodeLine{177 }
\DoxyCodeLine{178 \textcolor{keywordtype}{void} \mbox{\hyperlink{h1__connection_8h_a645eb4fc4a9ef93378396e59eba7bc24}{aws\_h1\_connection\_lock\_synced\_data}}(\textcolor{keyword}{struct} \mbox{\hyperlink{structaws__h1__connection}{aws\_h1\_connection}} *connection);}
\DoxyCodeLine{179 \textcolor{keywordtype}{void} \mbox{\hyperlink{h1__connection_8h_a73103a64bb83bf633e66a398262975ae}{aws\_h1\_connection\_unlock\_synced\_data}}(\textcolor{keyword}{struct} \mbox{\hyperlink{structaws__h1__connection}{aws\_h1\_connection}} *connection);}
\DoxyCodeLine{180 }
\DoxyCodeLine{188 \textcolor{keywordtype}{void} \mbox{\hyperlink{h1__connection_8h_a1d3af92b773ea5f2b8931b9599b48980}{aws\_h1\_connection\_try\_write\_outgoing\_stream}}(\textcolor{keyword}{struct} \mbox{\hyperlink{structaws__h1__connection}{aws\_h1\_connection}} *connection);}
\DoxyCodeLine{189 }
\DoxyCodeLine{199 \textcolor{keywordtype}{void} \mbox{\hyperlink{h1__connection_8h_a48d73cdf3b5e895cc18849b0a6a3f737}{aws\_h1\_connection\_try\_process\_read\_messages}}(\textcolor{keyword}{struct} \mbox{\hyperlink{structaws__h1__connection}{aws\_h1\_connection}} *connection);}
\DoxyCodeLine{200 }
\DoxyCodeLine{201 \textcolor{preprocessor}{\#endif }\textcolor{comment}{/* AWS\_HTTP\_H1\_CONNECTION\_H */}\textcolor{preprocessor}{}}

\end{DoxyCode}
