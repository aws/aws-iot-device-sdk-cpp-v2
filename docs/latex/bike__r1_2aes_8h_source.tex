\hypertarget{bike__r1_2aes_8h_source}{}\doxysection{aes.\+h}
\label{bike__r1_2aes_8h_source}\index{crt/aws-\/crt-\/cpp/crt/s2n/pq-\/crypto/bike\_r1/aes.h@{crt/aws-\/crt-\/cpp/crt/s2n/pq-\/crypto/bike\_r1/aes.h}}
\mbox{\hyperlink{bike__r1_2aes_8h}{Go to the documentation of this file.}}
\begin{DoxyCode}{0}
\DoxyCodeLine{1 \textcolor{comment}{/*}}
\DoxyCodeLine{2 \textcolor{comment}{ * Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.}}
\DoxyCodeLine{3 \textcolor{comment}{ *}}
\DoxyCodeLine{4 \textcolor{comment}{ * Licensed under the Apache License, Version 2.0 (the "{}License"{}).}}
\DoxyCodeLine{5 \textcolor{comment}{ * You may not use this file except in compliance with the License.}}
\DoxyCodeLine{6 \textcolor{comment}{ * A copy of the License is located at}}
\DoxyCodeLine{7 \textcolor{comment}{ *}}
\DoxyCodeLine{8 \textcolor{comment}{ * http://aws.amazon.com/apache2.0}}
\DoxyCodeLine{9 \textcolor{comment}{ *}}
\DoxyCodeLine{10 \textcolor{comment}{ * or in the "{}license"{} file accompanying this file. This file is distributed}}
\DoxyCodeLine{11 \textcolor{comment}{ * on an "{}AS IS"{} BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either}}
\DoxyCodeLine{12 \textcolor{comment}{ * express or implied. See the License for the specific language governing}}
\DoxyCodeLine{13 \textcolor{comment}{ * permissions and limitations under the License.}}
\DoxyCodeLine{14 \textcolor{comment}{ * The license is detailed in the file LICENSE.md, and applies to this file.}}
\DoxyCodeLine{15 \textcolor{comment}{ *}}
\DoxyCodeLine{16 \textcolor{comment}{ * Written by Nir Drucker and Shay Gueron}}
\DoxyCodeLine{17 \textcolor{comment}{ * AWS Cryptographic Algorithms Group.}}
\DoxyCodeLine{18 \textcolor{comment}{ * (ndrucker@amazon.com, gueron@amazon.com)}}
\DoxyCodeLine{19 \textcolor{comment}{ */}}
\DoxyCodeLine{20 }
\DoxyCodeLine{21 \textcolor{preprocessor}{\#pragma once}}
\DoxyCodeLine{22 }
\DoxyCodeLine{23 \textcolor{preprocessor}{\#include "{}\mbox{\hyperlink{bike__r2_2cleanup_8h}{cleanup.h}}"{}}}
\DoxyCodeLine{24 \textcolor{preprocessor}{\#include <openssl/evp.h>}}
\DoxyCodeLine{25 }
\DoxyCodeLine{26 \textcolor{preprocessor}{\#define MAX\_AES\_INVOKATION (MASK(32))}}
\DoxyCodeLine{27 }
\DoxyCodeLine{28 \textcolor{preprocessor}{\#define AES256\_KEY\_SIZE   (32ULL)}}
\DoxyCodeLine{29 \textcolor{preprocessor}{\#define AES256\_KEY\_BITS   (AES256\_KEY\_SIZE * 8)}}
\DoxyCodeLine{30 \textcolor{preprocessor}{\#define AES256\_BLOCK\_SIZE (16ULL)}}
\DoxyCodeLine{31 \textcolor{preprocessor}{\#define AES256\_ROUNDS     (14ULL)}}
\DoxyCodeLine{32 }
\DoxyCodeLine{33 \textcolor{keyword}{typedef} \mbox{\hyperlink{bike__r1_2aes_8h_a11851cca95ed74500e2cef2e7a7729c0}{ALIGN}}(16) struct aes256\_key\_s}
\DoxyCodeLine{34 \{}
\DoxyCodeLine{35   uint8\_t \mbox{\hyperlink{aws-c-iot_2include_2aws_2iotdevice_2external_2c_j_s_o_n_8h_a788db922597cf2fb6389e278f822e59f}{raw}}[\mbox{\hyperlink{bike__r1_2aes_8h_a5a64a2e860ad4e5012c6dbcd19c77210}{AES256\_KEY\_SIZE}}];}
\DoxyCodeLine{36 \} \mbox{\hyperlink{bike__r1_2aes_8h_a79c9473570a87f86eedd0d17c2ae36b7}{aes256\_key\_t}};}
\DoxyCodeLine{37 }
\DoxyCodeLine{38 \mbox{\hyperlink{bike__r1_2defs_8h_ad320c6003c1b51d78cb343e674b9432f}{\_INLINE\_}} \textcolor{keywordtype}{void}}
\DoxyCodeLine{39 \mbox{\hyperlink{bike__r1_2aes_8h_ac198f87d64b799a9e632745850c837d9}{aes256\_key\_cleanup}}(\mbox{\hyperlink{bike__r1_2aes_8h_a79c9473570a87f86eedd0d17c2ae36b7}{aes256\_key\_t}} *o)}
\DoxyCodeLine{40 \{}
\DoxyCodeLine{41   \mbox{\hyperlink{bike__r1_2cleanup_8h_a900c0ad7cbed6573e4767aa18709fa66}{secure\_clean}}(o-\/>raw, \textcolor{keyword}{sizeof}(*o));}
\DoxyCodeLine{42 \}}
\DoxyCodeLine{43 }
\DoxyCodeLine{44 \textcolor{comment}{// Using OpenSSL structures}}
\DoxyCodeLine{45 \textcolor{keyword}{typedef} EVP\_CIPHER\_CTX *\mbox{\hyperlink{bike__r1_2aes_8h_a02339f74806faf073c6ece7ddc667c7a}{aes256\_ks\_t}};}
\DoxyCodeLine{46 }
\DoxyCodeLine{47 \mbox{\hyperlink{bike__r1_2defs_8h_ad320c6003c1b51d78cb343e674b9432f}{\_INLINE\_}} \mbox{\hyperlink{s2n_2pq-crypto_2bike__r1_2error_8h_ae78f298365f3659d41525fa9b2b855e2}{ret\_t}}}
\DoxyCodeLine{48 \mbox{\hyperlink{bike__r1_2aes_8h_a807944307d8721f3b797fcf35d2074f2}{aes256\_key\_expansion}}(\mbox{\hyperlink{bike__r1__kem_8h_aec78e7a9e90a406a56f859ee456e8eae}{OUT}} \mbox{\hyperlink{bike__r1_2aes_8h_a02339f74806faf073c6ece7ddc667c7a}{aes256\_ks\_t}} *ks, \mbox{\hyperlink{bike__r1__kem_8h_ac2bbd6d630a06a980d9a92ddb9a49928}{IN}} \textcolor{keyword}{const} \mbox{\hyperlink{bike__r1_2aes_8h_a79c9473570a87f86eedd0d17c2ae36b7}{aes256\_key\_t}} *key)}
\DoxyCodeLine{49 \{}
\DoxyCodeLine{50   *ks = EVP\_CIPHER\_CTX\_new();}
\DoxyCodeLine{51   \textcolor{keywordflow}{if}(*ks == \mbox{\hyperlink{namespace_aws_a41b67e809416e9bd96026fa1f414925d}{NULL}})}
\DoxyCodeLine{52   \{}
\DoxyCodeLine{53     \mbox{\hyperlink{s2n_2pq-crypto_2bike__r1_2error_8h_afd0143325cf546e89c70dca08cae0cd6}{BIKE\_ERROR}}(\mbox{\hyperlink{s2n_2pq-crypto_2bike__r1_2error_8h_a16e0968bf2b44ba99b9a308421014f4daea0e29ca080099a04169f1e9182357b0}{EXTERNAL\_LIB\_ERROR\_OPENSSL}});}
\DoxyCodeLine{54   \}}
\DoxyCodeLine{55   \textcolor{keywordflow}{if}(0 == EVP\_EncryptInit\_ex(*ks, EVP\_aes\_256\_ecb(), \mbox{\hyperlink{namespace_aws_a41b67e809416e9bd96026fa1f414925d}{NULL}}, key-\/>raw, \mbox{\hyperlink{namespace_aws_a41b67e809416e9bd96026fa1f414925d}{NULL}}))}
\DoxyCodeLine{56   \{}
\DoxyCodeLine{57     EVP\_CIPHER\_CTX\_free(*ks);}
\DoxyCodeLine{58     \mbox{\hyperlink{s2n_2pq-crypto_2bike__r1_2error_8h_afd0143325cf546e89c70dca08cae0cd6}{BIKE\_ERROR}}(\mbox{\hyperlink{s2n_2pq-crypto_2bike__r1_2error_8h_a16e0968bf2b44ba99b9a308421014f4daea0e29ca080099a04169f1e9182357b0}{EXTERNAL\_LIB\_ERROR\_OPENSSL}});}
\DoxyCodeLine{59   \}}
\DoxyCodeLine{60 }
\DoxyCodeLine{61   EVP\_CIPHER\_CTX\_set\_padding(*ks, 0);}
\DoxyCodeLine{62 }
\DoxyCodeLine{63   \textcolor{keywordflow}{return} \mbox{\hyperlink{s2n_2pq-crypto_2bike__r1_2error_8h_aa90cac659d18e8ef6294c7ae337f6b58}{SUCCESS}};}
\DoxyCodeLine{64 \}}
\DoxyCodeLine{65 }
\DoxyCodeLine{66 \mbox{\hyperlink{bike__r1_2defs_8h_ad320c6003c1b51d78cb343e674b9432f}{\_INLINE\_}} \mbox{\hyperlink{s2n_2pq-crypto_2bike__r1_2error_8h_ae78f298365f3659d41525fa9b2b855e2}{ret\_t}}}
\DoxyCodeLine{67 \mbox{\hyperlink{bike__r1_2aes_8h_a8b3488b91a14b4c3801052d12eba63a7}{aes256\_enc}}(\mbox{\hyperlink{bike__r1__kem_8h_aec78e7a9e90a406a56f859ee456e8eae}{OUT}} uint8\_t *ct, \mbox{\hyperlink{bike__r1__kem_8h_ac2bbd6d630a06a980d9a92ddb9a49928}{IN}} \textcolor{keyword}{const} uint8\_t *pt, \mbox{\hyperlink{bike__r1__kem_8h_ac2bbd6d630a06a980d9a92ddb9a49928}{IN}} \textcolor{keyword}{const} \mbox{\hyperlink{bike__r1_2aes_8h_a02339f74806faf073c6ece7ddc667c7a}{aes256\_ks\_t}} *ks)}
\DoxyCodeLine{68 \{}
\DoxyCodeLine{69   \textcolor{keywordtype}{int} outlen = 0;}
\DoxyCodeLine{70   \textcolor{keywordflow}{if}(0 == EVP\_EncryptUpdate(*ks, ct, \&outlen, pt, \mbox{\hyperlink{bike__r1_2aes_8h_a53a76dc39f18601d88f17ed29a71d649}{AES256\_BLOCK\_SIZE}}))}
\DoxyCodeLine{71   \{}
\DoxyCodeLine{72     \mbox{\hyperlink{s2n_2pq-crypto_2bike__r1_2error_8h_afd0143325cf546e89c70dca08cae0cd6}{BIKE\_ERROR}}(\mbox{\hyperlink{s2n_2pq-crypto_2bike__r1_2error_8h_a16e0968bf2b44ba99b9a308421014f4daea0e29ca080099a04169f1e9182357b0}{EXTERNAL\_LIB\_ERROR\_OPENSSL}});}
\DoxyCodeLine{73   \}}
\DoxyCodeLine{74   \textcolor{keywordflow}{return} \mbox{\hyperlink{s2n_2pq-crypto_2bike__r1_2error_8h_aa90cac659d18e8ef6294c7ae337f6b58}{SUCCESS}};}
\DoxyCodeLine{75 \}}
\DoxyCodeLine{76 }
\DoxyCodeLine{77 \mbox{\hyperlink{bike__r1_2defs_8h_ad320c6003c1b51d78cb343e674b9432f}{\_INLINE\_}} \textcolor{keywordtype}{void}}
\DoxyCodeLine{78 \mbox{\hyperlink{bike__r1_2aes_8h_a1b4eab7c1996aded95a9956093e31bf6}{aes256\_free\_ks}}(\mbox{\hyperlink{bike__r1__kem_8h_aec78e7a9e90a406a56f859ee456e8eae}{OUT}} \mbox{\hyperlink{bike__r1_2aes_8h_a02339f74806faf073c6ece7ddc667c7a}{aes256\_ks\_t}} *ks)}
\DoxyCodeLine{79 \{}
\DoxyCodeLine{80   EVP\_CIPHER\_CTX\_free(*ks);}
\DoxyCodeLine{81   ks = \mbox{\hyperlink{namespace_aws_a41b67e809416e9bd96026fa1f414925d}{NULL}};}
\DoxyCodeLine{82 \}}

\end{DoxyCode}
