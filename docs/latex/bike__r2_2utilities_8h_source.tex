\hypertarget{bike__r2_2utilities_8h_source}{}\doxysection{utilities.\+h}
\label{bike__r2_2utilities_8h_source}\index{crt/aws-\/crt-\/cpp/crt/s2n/pq-\/crypto/bike\_r2/utilities.h@{crt/aws-\/crt-\/cpp/crt/s2n/pq-\/crypto/bike\_r2/utilities.h}}
\mbox{\hyperlink{bike__r2_2utilities_8h}{Go to the documentation of this file.}}
\begin{DoxyCode}{0}
\DoxyCodeLine{1 \textcolor{comment}{/* Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.}}
\DoxyCodeLine{2 \textcolor{comment}{ * SPDX-\/License-\/Identifier: Apache-\/2.0"{}}}
\DoxyCodeLine{3 \textcolor{comment}{ *}}
\DoxyCodeLine{4 \textcolor{comment}{ * Written by Nir Drucker and Shay Gueron}}
\DoxyCodeLine{5 \textcolor{comment}{ * AWS Cryptographic Algorithms Group.}}
\DoxyCodeLine{6 \textcolor{comment}{ * (ndrucker@amazon.com, gueron@amazon.com)}}
\DoxyCodeLine{7 \textcolor{comment}{ */}}
\DoxyCodeLine{8 }
\DoxyCodeLine{9 \textcolor{preprocessor}{\#pragma once}}
\DoxyCodeLine{10 }
\DoxyCodeLine{11 \textcolor{preprocessor}{\#include "{}\mbox{\hyperlink{bike__r2_2cleanup_8h}{cleanup.h}}"{}}}
\DoxyCodeLine{12 }
\DoxyCodeLine{13 \textcolor{preprocessor}{\#ifndef bswap\_64}}
\DoxyCodeLine{14 \textcolor{preprocessor}{\#  define bswap\_64(x) \_\_builtin\_bswap64(x)}}
\DoxyCodeLine{15 \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{16 }
\DoxyCodeLine{17 \textcolor{comment}{// Printing values in Little Endian}}
\DoxyCodeLine{18 \textcolor{keywordtype}{void}}
\DoxyCodeLine{19 \mbox{\hyperlink{bike__r1_2utilities_8h_a63762d3f6030e0e73dcc5bf5ccd8352f}{print\_LE}}(\mbox{\hyperlink{bike__r1__kem_8h_ac2bbd6d630a06a980d9a92ddb9a49928}{IN}} \textcolor{keyword}{const} uint64\_t *in, \mbox{\hyperlink{bike__r1__kem_8h_ac2bbd6d630a06a980d9a92ddb9a49928}{IN}} uint32\_t bits\_num);}
\DoxyCodeLine{20 }
\DoxyCodeLine{21 \textcolor{comment}{// Printing values in Big Endian}}
\DoxyCodeLine{22 \textcolor{keywordtype}{void}}
\DoxyCodeLine{23 \mbox{\hyperlink{bike__r1_2utilities_8h_a80641171c0b1ba009891977fe348f7d4}{print\_BE}}(\mbox{\hyperlink{bike__r1__kem_8h_ac2bbd6d630a06a980d9a92ddb9a49928}{IN}} \textcolor{keyword}{const} uint64\_t *in, \mbox{\hyperlink{bike__r1__kem_8h_ac2bbd6d630a06a980d9a92ddb9a49928}{IN}} uint32\_t bits\_num);}
\DoxyCodeLine{24 }
\DoxyCodeLine{25 \textcolor{comment}{// Printing number is required only in verbose level 2 or above}}
\DoxyCodeLine{26 \textcolor{preprocessor}{\#if VERBOSE >= 2}}
\DoxyCodeLine{27 \textcolor{preprocessor}{\#  ifdef PRINT\_IN\_BE}}
\DoxyCodeLine{28 \textcolor{comment}{// Print in Big Endian}}
\DoxyCodeLine{29 \textcolor{preprocessor}{\#    define print(name, in, bits\_num) \(\backslash\)}}
\DoxyCodeLine{30 \textcolor{preprocessor}{      do                              \(\backslash\)}}
\DoxyCodeLine{31 \textcolor{preprocessor}{      \{                               \(\backslash\)}}
\DoxyCodeLine{32 \textcolor{preprocessor}{        EDMSG(name);                  \(\backslash\)}}
\DoxyCodeLine{33 \textcolor{preprocessor}{        print\_BE(in, bits\_num);       \(\backslash\)}}
\DoxyCodeLine{34 \textcolor{preprocessor}{      \} while(0)}}
\DoxyCodeLine{35 \textcolor{preprocessor}{\#  else}}
\DoxyCodeLine{36 \textcolor{comment}{// Print in Little Endian}}
\DoxyCodeLine{37 \textcolor{preprocessor}{\#    define print(name, in, bits\_num) \(\backslash\)}}
\DoxyCodeLine{38 \textcolor{preprocessor}{      do                              \(\backslash\)}}
\DoxyCodeLine{39 \textcolor{preprocessor}{      \{                               \(\backslash\)}}
\DoxyCodeLine{40 \textcolor{preprocessor}{        EDMSG(name);                  \(\backslash\)}}
\DoxyCodeLine{41 \textcolor{preprocessor}{        print\_LE(in, bits\_num);       \(\backslash\)}}
\DoxyCodeLine{42 \textcolor{preprocessor}{      \} while(0)}}
\DoxyCodeLine{43 \textcolor{preprocessor}{\#  endif}}
\DoxyCodeLine{44 \textcolor{preprocessor}{\#else}}
\DoxyCodeLine{45 \textcolor{comment}{// No prints at all}}
\DoxyCodeLine{46 \textcolor{preprocessor}{\#  define print(name, in, bits\_num)}}
\DoxyCodeLine{47 \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{48 }
\DoxyCodeLine{49 \textcolor{comment}{// Comparing value in a constant time manner}}
\DoxyCodeLine{50 \mbox{\hyperlink{bike__r1_2defs_8h_ad320c6003c1b51d78cb343e674b9432f}{\_INLINE\_}} uint32\_t}
\DoxyCodeLine{51 \mbox{\hyperlink{bike__r1_2utilities_8h_afc1713d7e51f15b9c1c7e5624a8384fd}{secure\_cmp}}(\mbox{\hyperlink{bike__r1__kem_8h_ac2bbd6d630a06a980d9a92ddb9a49928}{IN}} \textcolor{keyword}{const} uint8\_t *\mbox{\hyperlink{namespace_aws_a63d22a0af7bbcae8152004baa4756a4d}{a}}, \mbox{\hyperlink{bike__r1__kem_8h_ac2bbd6d630a06a980d9a92ddb9a49928}{IN}} \textcolor{keyword}{const} uint8\_t *\mbox{\hyperlink{aws-c-iot_2include_2aws_2iotdevice_2external_2c_j_s_o_n_8h_a1a175e87536301df98c805ac0636ad7c}{b}}, \mbox{\hyperlink{bike__r1__kem_8h_ac2bbd6d630a06a980d9a92ddb9a49928}{IN}} \textcolor{keyword}{const} uint32\_t size)}
\DoxyCodeLine{52 \{}
\DoxyCodeLine{53   \textcolor{keyword}{volatile} uint8\_t res = 0;}
\DoxyCodeLine{54 }
\DoxyCodeLine{55   \textcolor{keywordflow}{for}(uint32\_t i = 0; i < size; ++i)}
\DoxyCodeLine{56   \{}
\DoxyCodeLine{57     res |= (\mbox{\hyperlink{namespace_aws_a63d22a0af7bbcae8152004baa4756a4d}{a}}[i] \string^ \mbox{\hyperlink{aws-c-iot_2include_2aws_2iotdevice_2external_2c_j_s_o_n_8h_a1a175e87536301df98c805ac0636ad7c}{b}}[i]);}
\DoxyCodeLine{58   \}}
\DoxyCodeLine{59 }
\DoxyCodeLine{60   \textcolor{keywordflow}{return} (0 == res);}
\DoxyCodeLine{61 \}}
\DoxyCodeLine{62 }
\DoxyCodeLine{63 uint64\_t}
\DoxyCodeLine{64 \mbox{\hyperlink{bike__r1_2utilities_8h_aba3669456277f081514296615e36cf6c}{r\_bits\_vector\_weight}}(\mbox{\hyperlink{bike__r1__kem_8h_ac2bbd6d630a06a980d9a92ddb9a49928}{IN}} \textcolor{keyword}{const} \mbox{\hyperlink{structr__s}{r\_t}} *in);}
\DoxyCodeLine{65 }
\DoxyCodeLine{66 \textcolor{comment}{// Constant time}}
\DoxyCodeLine{67 \mbox{\hyperlink{bike__r1_2defs_8h_ad320c6003c1b51d78cb343e674b9432f}{\_INLINE\_}} uint32\_t}
\DoxyCodeLine{68 \mbox{\hyperlink{bike__r1_2utilities_8h_a42c009f3f4bf4c7715b235f2541316ba}{iszero}}(\mbox{\hyperlink{bike__r1__kem_8h_ac2bbd6d630a06a980d9a92ddb9a49928}{IN}} \textcolor{keyword}{const} uint8\_t *s, \mbox{\hyperlink{bike__r1__kem_8h_ac2bbd6d630a06a980d9a92ddb9a49928}{IN}} \textcolor{keyword}{const} uint32\_t \mbox{\hyperlink{aws-c-iot_2include_2aws_2iotdevice_2external_2c_j_s_o_n_8h_a0f1e4ab31fd4f3ca4329091911f1f1af}{len}})}
\DoxyCodeLine{69 \{}
\DoxyCodeLine{70   \textcolor{keyword}{volatile} uint32\_t res = 0;}
\DoxyCodeLine{71   \textcolor{keywordflow}{for}(uint64\_t i = 0; i < \mbox{\hyperlink{aws-c-iot_2include_2aws_2iotdevice_2external_2c_j_s_o_n_8h_a0f1e4ab31fd4f3ca4329091911f1f1af}{len}}; i++)}
\DoxyCodeLine{72   \{}
\DoxyCodeLine{73     res |= s[i];}
\DoxyCodeLine{74   \}}
\DoxyCodeLine{75   \textcolor{keywordflow}{return} (0 == res);}
\DoxyCodeLine{76 \}}
\DoxyCodeLine{77 }
\DoxyCodeLine{78 \textcolor{comment}{// BSR returns ceil(log2(val))}}
\DoxyCodeLine{79 \mbox{\hyperlink{bike__r1_2defs_8h_ad320c6003c1b51d78cb343e674b9432f}{\_INLINE\_}} uint8\_t}
\DoxyCodeLine{80 \mbox{\hyperlink{bike__r1_2utilities_8h_a7ead18ca187534a8f737d240a7905fa7}{bit\_scan\_reverse}}(uint64\_t val)}
\DoxyCodeLine{81 \{}
\DoxyCodeLine{82   \textcolor{comment}{// index is always smaller than 64}}
\DoxyCodeLine{83   uint8\_t \mbox{\hyperlink{aws-c-iot_2include_2aws_2iotdevice_2external_2c_j_s_o_n_8h_a750b5d744c39a06bfb13e6eb010e35d0}{index}} = 0;}
\DoxyCodeLine{84 }
\DoxyCodeLine{85   \textcolor{keywordflow}{while}(val != 0)}
\DoxyCodeLine{86   \{}
\DoxyCodeLine{87     val >>= 1;}
\DoxyCodeLine{88     \mbox{\hyperlink{aws-c-iot_2include_2aws_2iotdevice_2external_2c_j_s_o_n_8h_a750b5d744c39a06bfb13e6eb010e35d0}{index}}++;}
\DoxyCodeLine{89   \}}
\DoxyCodeLine{90 }
\DoxyCodeLine{91   \textcolor{keywordflow}{return} \mbox{\hyperlink{aws-c-iot_2include_2aws_2iotdevice_2external_2c_j_s_o_n_8h_a750b5d744c39a06bfb13e6eb010e35d0}{index}};}
\DoxyCodeLine{92 \}}
\DoxyCodeLine{93 }
\DoxyCodeLine{94 \textcolor{comment}{// Return 1 if equal 0 otherwise}}
\DoxyCodeLine{95 \mbox{\hyperlink{bike__r1_2defs_8h_ad320c6003c1b51d78cb343e674b9432f}{\_INLINE\_}} uint32\_t}
\DoxyCodeLine{96 \mbox{\hyperlink{bike__r1_2utilities_8h_aed21704da30403372c916ae5fa8f1b9b}{secure\_cmp32}}(\mbox{\hyperlink{bike__r1__kem_8h_ac2bbd6d630a06a980d9a92ddb9a49928}{IN}} \textcolor{keyword}{const} uint32\_t v1, \mbox{\hyperlink{bike__r1__kem_8h_ac2bbd6d630a06a980d9a92ddb9a49928}{IN}} \textcolor{keyword}{const} uint32\_t v2)}
\DoxyCodeLine{97 \{}
\DoxyCodeLine{98 \textcolor{preprocessor}{\#if defined(\_\_aarch64\_\_)}}
\DoxyCodeLine{99   uint32\_t res;}
\DoxyCodeLine{100   \_\_asm\_\_ \_\_volatile\_\_(\textcolor{stringliteral}{"{}cmp  \%w1, \%w2; \(\backslash\)n "{}}}
\DoxyCodeLine{101                        \textcolor{stringliteral}{"{}cset \%w0, EQ; \(\backslash\)n"{}}}
\DoxyCodeLine{102                        : \textcolor{stringliteral}{"{}=r"{}}(res)}
\DoxyCodeLine{103                        : \textcolor{stringliteral}{"{}r"{}}(v1), \textcolor{stringliteral}{"{}r"{}}(v2)}
\DoxyCodeLine{104                        :);}
\DoxyCodeLine{105   \textcolor{keywordflow}{return} res;}
\DoxyCodeLine{106 \textcolor{preprocessor}{\#elif defined(\_\_x86\_64\_\_) || defined(\_\_i386\_\_)}}
\DoxyCodeLine{107   uint32\_t res;}
\DoxyCodeLine{108   \_\_asm\_\_ \_\_volatile\_\_(\textcolor{stringliteral}{"{}xor  \%\%edx, \%\%edx; \(\backslash\)n"{}}}
\DoxyCodeLine{109                        \textcolor{stringliteral}{"{}cmp  \%1, \%2; \(\backslash\)n "{}}}
\DoxyCodeLine{110                        \textcolor{stringliteral}{"{}sete \%\%dl; \(\backslash\)n"{}}}
\DoxyCodeLine{111                        \textcolor{stringliteral}{"{}mov \%\%edx, \%0; \(\backslash\)n"{}}}
\DoxyCodeLine{112                        : \textcolor{stringliteral}{"{}=r"{}}(res)}
\DoxyCodeLine{113                        : \textcolor{stringliteral}{"{}r"{}}(v1), \textcolor{stringliteral}{"{}r"{}}(v2)}
\DoxyCodeLine{114                        : \textcolor{stringliteral}{"{}rdx"{}});}
\DoxyCodeLine{115   \textcolor{keywordflow}{return} res;}
\DoxyCodeLine{116 \textcolor{preprocessor}{\#else}}
\DoxyCodeLine{117   \textcolor{comment}{// Insecure comparison: The main purpose of secure\_cmp32 is to avoid}}
\DoxyCodeLine{118   \textcolor{comment}{// branches and thus to prevent potential side channel attacks. To do that}}
\DoxyCodeLine{119   \textcolor{comment}{// we normally leverage some CPU special instructions such as "{}sete"{}}}
\DoxyCodeLine{120   \textcolor{comment}{// (for \_\_x86\_64\_\_) and "{}cset"{} (for \_\_aarch64\_\_). When dealing with general}}
\DoxyCodeLine{121   \textcolor{comment}{// CPU architectures, the interpretation of the line below is left for the}}
\DoxyCodeLine{122   \textcolor{comment}{// compiler, which may lead to an insecure branch.}}
\DoxyCodeLine{123   \textcolor{keywordflow}{return} (v1 == v2 ? 1 : 0);}
\DoxyCodeLine{124 \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{125 \}}
\DoxyCodeLine{126 }
\DoxyCodeLine{127 \textcolor{comment}{// Return 0 if v1 < v2, (-\/1) otherwise}}
\DoxyCodeLine{128 \mbox{\hyperlink{bike__r1_2defs_8h_ad320c6003c1b51d78cb343e674b9432f}{\_INLINE\_}} uint32\_t}
\DoxyCodeLine{129 \mbox{\hyperlink{bike__r1_2utilities_8h_a1fa5749b57e59e9f726773eb9ffaf228}{secure\_l32\_mask}}(\mbox{\hyperlink{bike__r1__kem_8h_ac2bbd6d630a06a980d9a92ddb9a49928}{IN}} \textcolor{keyword}{const} uint32\_t v1, \mbox{\hyperlink{bike__r1__kem_8h_ac2bbd6d630a06a980d9a92ddb9a49928}{IN}} \textcolor{keyword}{const} uint32\_t v2)}
\DoxyCodeLine{130 \{}
\DoxyCodeLine{131 \textcolor{preprocessor}{\#if defined(\_\_aarch64\_\_)}}
\DoxyCodeLine{132   uint32\_t res;}
\DoxyCodeLine{133   \_\_asm\_\_ \_\_volatile\_\_(\textcolor{stringliteral}{"{}cmp  \%w2, \%w1; \(\backslash\)n "{}}}
\DoxyCodeLine{134                        \textcolor{stringliteral}{"{}cset \%w0, HI; \(\backslash\)n"{}}}
\DoxyCodeLine{135                        : \textcolor{stringliteral}{"{}=r"{}}(res)}
\DoxyCodeLine{136                        : \textcolor{stringliteral}{"{}r"{}}(v1), \textcolor{stringliteral}{"{}r"{}}(v2)}
\DoxyCodeLine{137                        :);}
\DoxyCodeLine{138   \textcolor{keywordflow}{return} (res -\/ 1);}
\DoxyCodeLine{139 \textcolor{preprocessor}{\#elif defined(\_\_x86\_64\_\_) || defined(\_\_i386\_\_)}}
\DoxyCodeLine{140   uint32\_t res;}
\DoxyCodeLine{141   \_\_asm\_\_ \_\_volatile\_\_(\textcolor{stringliteral}{"{}xor  \%\%edx, \%\%edx; \(\backslash\)n"{}}}
\DoxyCodeLine{142                        \textcolor{stringliteral}{"{}cmp  \%1, \%2; \(\backslash\)n "{}}}
\DoxyCodeLine{143                        \textcolor{stringliteral}{"{}setl \%\%dl; \(\backslash\)n"{}}}
\DoxyCodeLine{144                        \textcolor{stringliteral}{"{}dec \%\%edx; \(\backslash\)n"{}}}
\DoxyCodeLine{145                        \textcolor{stringliteral}{"{}mov \%\%edx, \%0; \(\backslash\)n"{}}}
\DoxyCodeLine{146 }
\DoxyCodeLine{147                        : \textcolor{stringliteral}{"{}=r"{}}(res)}
\DoxyCodeLine{148                        : \textcolor{stringliteral}{"{}r"{}}(v2), \textcolor{stringliteral}{"{}r"{}}(v1)}
\DoxyCodeLine{149                        : \textcolor{stringliteral}{"{}rdx"{}});}
\DoxyCodeLine{150 }
\DoxyCodeLine{151   \textcolor{keywordflow}{return} res;}
\DoxyCodeLine{152 \textcolor{preprocessor}{\#else}}
\DoxyCodeLine{153   \textcolor{comment}{// If v1 >= v2 then the subtraction result is 0\string^32||(v1-\/v2)}}
\DoxyCodeLine{154   \textcolor{comment}{// else it will be 1\string^32||(v2-\/v1+1). Subsequently, negating the upper}}
\DoxyCodeLine{155   \textcolor{comment}{// 32 bits gives 0 if v1 < v2 and otherwise (-\/1).}}
\DoxyCodeLine{156   \textcolor{keywordflow}{return} \string~((uint32\_t)(((uint64\_t)v1 -\/ (uint64\_t)v2) >> 32));}
\DoxyCodeLine{157 \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{158 \}}

\end{DoxyCode}
