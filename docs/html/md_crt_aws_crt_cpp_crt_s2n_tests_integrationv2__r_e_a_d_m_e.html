<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.2"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>AWS IoT Device SDK C++ v2: Quick start</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">AWS IoT Device SDK C++ v2<span id="projectnumber">&#160;1.14.0</span>
   </div>
   <div id="projectbrief">AWS IoT Device SDK C++ v2</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.2 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search",'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div><div class="header">
  <div class="headertitle"><div class="title">Quick start </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p >You must have run through the standard codebuild setup as described in the root README. This will make sure you have all the dependencies installed correctly. The integration test dependencies are:</p>
<ul>
<li>s2nc and s2nd (should be in the bin/ directory)</li>
<li>libs2n (should be in the lib/ directory)</li>
<li>openssl (based on the S2N_LIBCRYPTO env var)</li>
<li>tox</li>
</ul>
<h1><a class="anchor" id="autotoc_md550"></a>
Run all tests</h1>
<p >The fastest way to run the integrationv2 tests is to run <code>make</code> in the integrationv2 directory.</p>
<div class="fragment"><div class="line">ubuntu@host:tests/integrationv2/ $ make</div>
</div><!-- fragment --><p >This will automatically setup your PATH and LD_LIBRARY_PATH environment. It will execute <code>tox</code> to setup your Python environment. Then all the integration tests will be collected and executed.</p>
<p ><b>Note</b> If you are running the dynamic record size test you will need to use <code>sudo</code>.</p>
<h1><a class="anchor" id="autotoc_md551"></a>
Run one test</h1>
<p >You can run the entire test suite using <code>sudo make</code>. You need to use <code>sudo</code> if you plan on running the dynamic record tests.</p>
<p >If you only want to run a single test, you can set the <code>TOX_TEST_NAME</code> environment variable:</p>
<div class="fragment"><div class="line">ubuntu@host:tests/integrationv2$ TOX_TEST_NAME=test_happy_path.py::test_s2n_server_happy_path make</div>
</div><!-- fragment --><p >This will setup your environment correctly, and execute the single test.</p>
<h1><a class="anchor" id="autotoc_md552"></a>
A toy example</h1>
<p >The happy path test combines thousands of parameters, and has to validate that the combinations match. Below is a simple test that demonstrates how lists of parameters are combined to test all possible parameter combinations.</p>
<div class="fragment"><div class="line"><span class="keyword">import</span> copy</div>
<div class="line"><span class="keyword">import</span> pytest</div>
<div class="line"> </div>
<div class="line"><span class="keyword">from</span> configuration <span class="keyword">import</span> available_ports, ALL_CERTS</div>
<div class="line"><span class="keyword">from</span> common <span class="keyword">import</span> ProviderOptions, Cert, Ciphers, Protocols</div>
<div class="line"><span class="keyword">from</span> fixtures <span class="keyword">import</span> managed_process</div>
<div class="line"><span class="keyword">from</span> providers <span class="keyword">import</span> Provider, S2N, OpenSSL</div>
<div class="line"><span class="keyword">from</span> utils <span class="keyword">import</span> get_parameter_name, get_expected_s2n_version</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="stringliteral">&quot;&quot;&quot;</span></div>
<div class="line"><span class="stringliteral">Pytest will generate 8 configuration based on the parameterize options below. The</span></div>
<div class="line"><span class="stringliteral">test will be run with each of the possible configurations.</span></div>
<div class="line"><span class="stringliteral">&quot;&quot;&quot;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">@pytest.mark.parametrize</span>(<span class="stringliteral">&quot;cipher&quot;</span>,</div>
<div class="line">    [Ciphers.AES128_GCM_SHA256, Ciphers.CHACHA20_POLY1305_SHA256], ids=get_parameter_name)</div>
<div class="line"><span class="preprocessor">@pytest.mark.parametrize</span>(<span class="stringliteral">&quot;provider&quot;</span>,</div>
<div class="line">    [S2N, OpenSSL])</div>
<div class="line"><span class="preprocessor">@pytest.mark.parametrize</span>(<span class="stringliteral">&quot;protocol&quot;</span>,</div>
<div class="line">    [Protocols.TLS13], ids=get_parameter_name)</div>
<div class="line"><span class="preprocessor">@pytest.mark.parametrize</span>(<span class="stringliteral">&quot;certificate&quot;</span>,</div>
<div class="line">    [Cert(<span class="stringliteral">&quot;ECDSA_256&quot;</span>, <span class="stringliteral">&quot;ecdsa_p256_pkcs1&quot;</span>), Cert(<span class="stringliteral">&quot;ECDSA_384&quot;</span>, <span class="stringliteral">&quot;ecdsa_p384_pkcs1&quot;</span>)], ids=get_parameter_name)</div>
<div class="line"><span class="keyword">def </span>test_example(managed_process, cipher, provider, protocol, certificate):</div>
<div class="line">    host = <span class="stringliteral">&quot;localhost&quot;</span></div>
<div class="line">    port = <a class="code hl_variable" href="namespace_aws.html#ae0af31e16c5e60e82beaa1de641126e7">next</a>(available_ports)</div>
<div class="line"> </div>
<div class="line">    client_options = ProviderOptions(</div>
<div class="line">        mode=Provider.ClientMode,</div>
<div class="line">        host=<span class="stringliteral">&quot;localhost&quot;</span>,</div>
<div class="line">        port=port,</div>
<div class="line">        cipher=cipher,</div>
<div class="line">        insecure=<span class="keyword">True</span>,</div>
<div class="line">        protocol=protocol)</div>
<div class="line"> </div>
<div class="line">    server_options = copy.copy(client_options)</div>
<div class="line">    server_options.mode = Provider.ServerMode</div>
<div class="line">    server_options.key = certificate.key</div>
<div class="line">    server_options.cert = certificate.cert</div>
<div class="line"> </div>
<div class="line">    expected_version = get_expected_s2n_version(protocol, provider)</div>
<div class="line"> </div>
<div class="line">    server = <a class="code hl_function" href="namespacefixtures.html#a8e43f0fdf6000c3baaf0fdc8663070b0">managed_process</a>(provider, server_options, timeout=5)</div>
<div class="line">    client = <a class="code hl_function" href="namespacefixtures.html#a8e43f0fdf6000c3baaf0fdc8663070b0">managed_process</a>(S2N, client_options, timeout=5)</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">for</span> results <span class="keywordflow">in</span> client.get_results():</div>
<div class="line">        <span class="keyword">assert</span> results.exception <span class="keywordflow">is</span> <span class="keywordtype">None</span></div>
<div class="line">        <span class="keyword">assert</span> results.exit_code == 0</div>
<div class="line">        <span class="keyword">assert</span> bytes(<span class="stringliteral">&quot;Actual protocol version: {}&quot;</span>.<a class="code hl_variable" href="namespace_aws.html#a5b080fcf4aed7e14fb25c2638948af06">format</a>(expected_version).encode(<span class="stringliteral">&#39;utf-8&#39;</span>)) <span class="keywordflow">in</span> results.stdout</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">for</span> results <span class="keywordflow">in</span> server.get_results():</div>
<div class="line">        <span class="keyword">assert</span> results.exception <span class="keywordflow">is</span> <span class="keywordtype">None</span></div>
<div class="line">        <span class="keyword">assert</span> results.exit_code == 0</div>
<div class="ttc" id="anamespace_aws_html_a5b080fcf4aed7e14fb25c2638948af06"><div class="ttname"><a href="namespace_aws.html#a5b080fcf4aed7e14fb25c2638948af06">Aws::format</a></div><div class="ttdeci">p format</div><div class="ttdef"><b>Definition:</b> cJSON.cpp:1041</div></div>
<div class="ttc" id="anamespace_aws_html_ae0af31e16c5e60e82beaa1de641126e7"><div class="ttname"><a href="namespace_aws.html#ae0af31e16c5e60e82beaa1de641126e7">Aws::next</a></div><div class="ttdeci">item next</div><div class="ttdef"><b>Definition:</b> cJSON.cpp:1820</div></div>
<div class="ttc" id="anamespacefixtures_html_a8e43f0fdf6000c3baaf0fdc8663070b0"><div class="ttname"><a href="namespacefixtures.html#a8e43f0fdf6000c3baaf0fdc8663070b0">fixtures.managed_process</a></div><div class="ttdeci">def managed_process()</div><div class="ttdef"><b>Definition:</b> fixtures.py:13</div></div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md553"></a>
Testing a new feature</h1>
<p >If you are testing a new feature you need to determine how to use that feature with all supported providers.</p>
<h2><a class="anchor" id="autotoc_md554"></a>
s2nd / s2nc</h2>
<p >You may have to add a command line flag to <a class="el" href="s2nc_8c.html">s2nc.c</a> or <a class="el" href="s2nd_8c.html">s2nd.c</a> for your feature. Use long options if possible, and use the same option name in both <a class="el" href="s2nc_8c.html">s2nc.c</a> and <a class="el" href="s2nd_8c.html">s2nd.c</a>. If you are able to use an option name similar to the OpenSSL name, please do. This reduces complexity across TLS providers.</p>
<p >An example of similar naming is '-reconnect' in OpenSSL and '-r' in S2N. Both have a hardcoded value of 5 reconnects. The point is to remove logic from the test, and make the providers act as similar as possible.</p>
<h2><a class="anchor" id="autotoc_md555"></a>
Control the provider from the test</h2>
<p >If you are testing a feature which is similar across all TLS providers, add an option to the ProviderOptions object in <code><a class="el" href="common_8py.html">common.py</a></code>. If this feature is specific to a single provider, you can use the <code>extra_flags</code> option.</p>
<p >For example, to test the session resumption feature we need to tell various clients and servers to resume a session multiple times. To do this we added the 'reconnect' and 'reconnects_before_exit' options to the ProviderOptions object. But with the dynamic threshold feature we simply pass the '-D' argument as an <code>extra_flag</code> to s2n.</p>
<p >In each provider that supports your feature you need to check if the flag is set, and create a command line option for that particular provider. You can also add logic checks, e.g with client authentication the client must have a certificate to send. Otherwise the test will fail.</p>
<h2><a class="anchor" id="autotoc_md556"></a>
Fine-tune how input data is sent in the tests</h2>
<p >There are several optional arguments in the managed_process function. Use these arguments to have a greater level of control over how peers send test data. The argument send_marker can be used in parallel with the data_to_send Provider options. If both of these arguments are lists, the process will only write a data_to_send element when it reads a corresponding send_marker element from the process's stdout or stderr. Additionally, the managed_process argument close_marker can be used to control when the process should shut down.</p>
<p >An example of how to test that the server and the client can send and receive application data: </p><div class="fragment"><div class="line">server_options.data_to_send = [&quot;First server message&quot;, &quot;Second server message&quot;]</div>
<div class="line">server_send_marker = [&quot;Ready to send data&quot;, &quot;First client message&quot;]</div>
<div class="line">server_close_marker = [&quot;Second client message&quot;]</div>
<div class="line"> </div>
<div class="line">client_options.data_to_send = [&quot;First client message&quot;, &quot;Second client message&quot;]</div>
<div class="line">client_send_marker = [&quot;Ready to send data&quot;, &quot;First server message&quot;]</div>
<div class="line">client_close_marker = [&quot;Second server message&quot;]</div>
<div class="line"> </div>
<div class="line">server = managed_process(provider, server_options, server_send_marker, server_close_marker, timeout=5)</div>
<div class="line">client = managed_process(S2N, client_options, client_send_marker, client_close_marker, timeout=5)</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md557"></a>
Troubleshooting</h1>
<p ><b>INTERNALERROR&gt; OSError: cannot send to &lt;Channel id=1 closed&gt;</b> An error similar to this is caused by a runtime error in a test. In <code>tox.ini</code> change <code>-n8</code> to <code>-n0</code> to see the actual error causing the OSError. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.2
</small></address>
</body>
</html>
