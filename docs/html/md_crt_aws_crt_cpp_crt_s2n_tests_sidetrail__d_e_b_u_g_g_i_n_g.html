<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.2"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>AWS IoT Device SDK C++ v2: Debugging SideTrail</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">AWS IoT Device SDK C++ v2<span id="projectnumber">&#160;1.14.0</span>
   </div>
   <div id="projectbrief">AWS IoT Device SDK C++ v2</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.2 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search",'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div><div class="header">
  <div class="headertitle"><div class="title">Debugging SideTrail </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p >This is a guide for what to do when SideTrail reports a potential timing violation / throws a red <code>x</code> in CI.</p>
<ul>
<li><a href="#how-to-locally-rerun-the-tests">How to locally rerun the tests</a></li>
<li><a href="#updating-the-patch-files">Updating the patch files</a></li>
<li><a href="#undefined-functions">Undefined functions</a></li>
<li><a href="#loop-related-errors">Loop related errors</a></li>
<li><a href="#warning-no-entrypoints-found">Warning: No entrypoints found.</a></li>
<li><a href="#sidetrail-fails-with-a-long-error-trace">SideTrail fails with a long error trace</a></li>
<li><a href="#what-to-do-if-the-proof-gets-really-slow">What to do if the proof gets really slow</a></li>
<li><a href="#expected-runtimes">Expected runtimes:</a></li>
</ul>
<h1><a class="anchor" id="autotoc_md581"></a>
How to locally rerun the tests</h1>
<p >The first step to debugging is to locally rerun the failing proof(s). Follow <a href="README.md#how-to-execute-the-tests">the instructions here</a> to get SideTrail docker container and execute the tests.</p>
<h1><a class="anchor" id="autotoc_md582"></a>
Updating the patch files</h1>
<p >The most common error you are likely to see is a failure to apply the necessary patches. Sidetrail depends on a set of patch files, stored in the <code>s2n/tests/sidetrail/working/patches</code>. These files patch away certain C constructs that SideTrail has trouble with. They are applied by the <code>copy_as_needed.sh</code> script in each proof. If the file they are patching is modified, <code>patch</code> may be unable to apply the needed patches, and fail with an error.</p>
<div class="fragment"><div class="line">patching file utils/s2n_safety.c</div>
<div class="line">Hunk #1 FAILED at 57.</div>
<div class="line">1 out of 2 hunks FAILED -- saving rejects to file utils/s2n_safety.c.rej</div>
</div><!-- fragment --><p >To fix this, regenerate the patch file.</p>
<ol type="1">
<li>View the failing patch to see what it does. It may be useful to apply it to a previous version of the file, so you can see what the patched file looks like. Identify any failing chunks, and figure out why they are failing to apply.</li>
<li>In a clean branch of s2n, modify the file in need of patching to have the required changes. Work directly on the file in the s2n src folders - we will revert it back before committing our changes. You may find it useful to also (temporarily) modify the <code>copy_as_needed.sh</code> file <a href="https://github.com/awslabs/s2n/blob/main/tests/sidetrail/working/s2n-cbc/copy_as_needed.sh">(example)</a> to just copy the file, and not patch it.</li>
<li>Iterate on the file in need of patching until the tests pass.</li>
<li>In the <code>s2n/tests/sidetrail/working/patches</code> folder, regenerate the patch using <code>git diff -u &lt;path-to-changed-file&gt; &gt; &lt;patch_filename&gt;.patch</code></li>
<li>Restore all other changed files using <code>git checkout</code>.</li>
<li>Some of the current patch files were not generated following this standard procedure, and hence are invoked using <code>-p5</code>, instead of the <code>-p1</code> this procedure will generate. You may need to change the <code>./copy_as_needed.sh</code> files to use the correct <code>-p</code> level.</li>
<li>Rerun the proofs using the docker container to ensure they work.</li>
<li>Commit the new patch file, and attach it to your PR.</li>
</ol>
<h1><a class="anchor" id="autotoc_md583"></a>
Undefined functions</h1>
<p >Another common error comes if a new function is called, for which SideTrail does not have a definition. In this case, you will see a warning like:</p>
<div class="fragment"><div class="line">warning: module contains undefined functions: malloc, __CONTRACT_invariant, nondet, foo</div>
</div><!-- fragment --><p >The list above is the list of functions for which SMACK does not have a model. In some cases, this is expected and benign &mdash; you can find a list of <code>allowed_undefined</code> functions <a href="https://github.com/awslabs/s2n/blob/main/tests/sidetrail/count_success.pl#L33">here</a>. If there are any functions in the warning that are not in that list, then one of three things needs to happen.</p>
<ol type="1">
<li>The new function does not need a timing stub, and should be added to the list of <code>allowed_undefined</code>.</li>
</ol>
<ol type="1">
<li>The new function is in a file that SideTrail doesn't currently compile. Update <code>Makefile</code> and <code>copy_as_needed.sh</code> for the proof, and rerun.</li>
</ol>
<ol type="1">
<li>The new function needs a timing stub. Take a look at existing timing stubs in the <code>working/stubs</code> folder to see what these look like, and how to write them.</li>
</ol>
<h1><a class="anchor" id="autotoc_md584"></a>
Loop related errors</h1>
<p >When Sidetrail analyzes a program, it needs to know how many times a loop will execute. If Sidetrail encounters a loop, and can't tell how many times it will execute, it may give a spurious counterexample. You can fix this using the <code>S2N_INVARIENT</code> macro. A good example of this is in <code>s2n_constant_time_equals</code>.</p>
<div class="fragment"><div class="line">uint8_t <a class="code hl_function" href="aes__c_8c.html#a1e1745fde8c90d73e5304314a30c0d23">xor</a> = 0;</div>
<div class="line"><span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; <a class="code hl_variable" href="aws-c-iot_2include_2aws_2iotdevice_2external_2c_j_s_o_n_8h.html#a0f1e4ab31fd4f3ca4329091911f1f1af">len</a>; i++) {</div>
<div class="line">    <span class="comment">/* Invariants must hold for each execution of the loop</span></div>
<div class="line"><span class="comment"> * and at loop exit, hence the &lt;= */</span></div>
<div class="line">    <a class="code hl_define" href="sidetrail_2working_2s2n-cbc_2stubs_2s2n__annotations_8h.html#a535b22580ac6790a65c3ad3baa8ff119">S2N_INVARIENT</a>(i &lt;= <a class="code hl_variable" href="aws-c-iot_2include_2aws_2iotdevice_2external_2c_j_s_o_n_8h.html#a0f1e4ab31fd4f3ca4329091911f1f1af">len</a>);</div>
<div class="line">    <a class="code hl_function" href="aes__c_8c.html#a1e1745fde8c90d73e5304314a30c0d23">xor</a> |= <a class="code hl_variable" href="namespace_aws.html#a63d22a0af7bbcae8152004baa4756a4d">a</a>[i] ^ <a class="code hl_variable" href="aws-c-iot_2include_2aws_2iotdevice_2external_2c_j_s_o_n_8h.html#a1a175e87536301df98c805ac0636ad7c">b</a>[i];</div>
<div class="line">}</div>
<div class="ttc" id="aaes__c_8c_html_a1e1745fde8c90d73e5304314a30c0d23"><div class="ttname"><a href="aes__c_8c.html#a1e1745fde8c90d73e5304314a30c0d23">xor</a></div><div class="ttdeci">static void xor(byte *a, const byte *b, int n)</div><div class="ttdef"><b>Definition:</b> aes_c.c:171</div></div>
<div class="ttc" id="aaws-c-iot_2include_2aws_2iotdevice_2external_2c_j_s_o_n_8h_html_a0f1e4ab31fd4f3ca4329091911f1f1af"><div class="ttname"><a href="aws-c-iot_2include_2aws_2iotdevice_2external_2c_j_s_o_n_8h.html#a0f1e4ab31fd4f3ca4329091911f1f1af">len</a></div><div class="ttdeci">char const int len</div><div class="ttdef"><b>Definition:</b> cJSON.h:169</div></div>
<div class="ttc" id="aaws-c-iot_2include_2aws_2iotdevice_2external_2c_j_s_o_n_8h_html_a1a175e87536301df98c805ac0636ad7c"><div class="ttname"><a href="aws-c-iot_2include_2aws_2iotdevice_2external_2c_j_s_o_n_8h.html#a1a175e87536301df98c805ac0636ad7c">b</a></div><div class="ttdeci">const cJSON *const b</div><div class="ttdef"><b>Definition:</b> cJSON.h:259</div></div>
<div class="ttc" id="anamespace_aws_html_a63d22a0af7bbcae8152004baa4756a4d"><div class="ttname"><a href="namespace_aws.html#a63d22a0af7bbcae8152004baa4756a4d">Aws::a</a></div><div class="ttdeci">cJSON * a</div><div class="ttdef"><b>Definition:</b> cJSON.cpp:2081</div></div>
<div class="ttc" id="asidetrail_2working_2s2n-cbc_2stubs_2s2n__annotations_8h_html_a535b22580ac6790a65c3ad3baa8ff119"><div class="ttname"><a href="sidetrail_2working_2s2n-cbc_2stubs_2s2n__annotations_8h.html#a535b22580ac6790a65c3ad3baa8ff119">S2N_INVARIENT</a></div><div class="ttdeci">#define S2N_INVARIENT(__a)</div><div class="ttdef"><b>Definition:</b> s2n_annotations.h:22</div></div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md585"></a>
Warning: No entrypoints found.</h1>
<p >For unknown reasons, this warning sometimes appears in CI, although the same docker container does not display it when run locally. This appears to be benign, although we are investigating and hope to close it out.</p>
<h1><a class="anchor" id="autotoc_md586"></a>
SideTrail fails with a long error trace</h1>
<p >Your best bet here is to do delta-debugging to get a minimal reproducing test case. Take a look at the test-case. Did it introduce a timing violation? If so, fix it.</p>
<p >If you can't see an obvious timing issue in the minimal reproducing case, it may be worth taking a look at the trace. The trace is not easy to read, and is super long. I've found the best thing is to dump it to a file, and then to start annotating that file with the call-stack that led to the failure. In particular, the trace will consist of two sequential traces: the initial, and the "shadow" trace. Those should be equal - if they are not, that's where the timing violation comes in. Look for the place where the two traces diverged.</p>
<h1><a class="anchor" id="autotoc_md587"></a>
What to do if the proof gets really slow</h1>
<ol type="1">
<li>Delta-debugging is your friend here. Find the last fast commit. Then, apply parts of the diff until it suddenly gets slow. That's your culprit.</li>
</ol>
<ol type="1">
<li>Slowdown is often because alias analysis has failed to distinguish cases that can't actually alias. Sidetrail exports information about how many alias sets it had as part of its output. Did that change from the last fast version? In this case, sometimes simple syntatic changes are enough to fix it; if that doesn't work, consult an AR expert.</li>
</ol>
<h1><a class="anchor" id="autotoc_md588"></a>
Expected runtimes:</h1>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Test name   </th><th class="markdownTableHeadRight">Runtime    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">s2n-record-read-cbc-negative-test   </td><td class="markdownTableBodyRight">20s    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">s2n-cbc   </td><td class="markdownTableBodyRight">5m 45s    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">s2n-record-read-composite   </td><td class="markdownTableBodyRight">15s    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">s2n-record-read-aead   </td><td class="markdownTableBodyRight">4m 10s    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">s2n-record-read-stream   </td><td class="markdownTableBodyRight">25s    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">s2n-record-read-cbc   </td><td class="markdownTableBodyRight">20s   </td></tr>
</table>
</div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.2
</small></address>
</body>
</html>
