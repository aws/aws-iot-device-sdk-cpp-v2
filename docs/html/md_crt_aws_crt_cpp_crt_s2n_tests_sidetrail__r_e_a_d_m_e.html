<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.2"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>AWS IoT Device SDK C++ v2: Constant Time Verification Tests for s2n</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">AWS IoT Device SDK C++ v2<span id="projectnumber">&#160;1.14.0</span>
   </div>
   <div id="projectbrief">AWS IoT Device SDK C++ v2</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.2 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search",'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div><div class="header">
  <div class="headertitle"><div class="title">Constant Time Verification Tests for s2n </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p >This repository contains tests which ensure that key s2n functions are not susceptible to timing attacks. For more details, see <a href="https://github.com/awslabs/s2n/issues/463">https://github.com/awslabs/s2n/issues/463</a></p>
<p ><b>Table of Contents</b> <br  />
</p>
<ul>
<li><a href="#what-are-timing-side-channels">What are timing side channels</a></li>
<li><a href="#s2n-countermeasures-against-timing-side-channels">s2n countermeasures against timing side channels</a></li>
<li><a href="#why-use-formal-methods-to-prove-the-correctness-of-s2ns-countermeasures">Why use formal methods to prove the correctness of s2n's countermeasures?</a></li>
<li><a href="#how-does-sidetrail-prove-the-correctness-of-code-blinding-countermeasures">How does SideTrail prove the correctness of code blinding countermeasures</a><ul>
<li><a href="#high-level-overview">High level overview</a></li>
<li><a href="#user-annotations">User annotations</a></li>
<li><a href="#the-gory-details">The gory details</a></li>
</ul>
</li>
<li><a href="#how-to-execute-the-tests">How to execute the tests</a><ul>
<li><a href="#get-docker">Get Docker</a></li>
<li><a href="#building-the-image">Building the image</a></li>
<li><a href="#starting-docker">Starting docker</a></li>
<li><a href="#running-a-proof-inside-docker">Running a proof inside docker</a></li>
</ul>
</li>
<li><a href="#debugging-sidetrail-failures">Debugging SideTrail failures</a></li>
<li><a href="#questions">Questions?</a></li>
</ul>
<h1><a class="anchor" id="autotoc_md590"></a>
What are timing side channels</h1>
<p >Cryptographic protocols such as TLS are supposed to keep secret information secret. They do this by ensuring that WHICH bytes go over the wire is hidden using encryption. However, if the code is not carefully written, WHEN bytes go over the wire may depend on values that were supposed to remain secret.</p>
<p >For example, if code checks a password as follows</p>
<div class="fragment"><div class="line"><span class="keywordflow">for</span> (i = 0; i &lt; <a class="code hl_typedef" href="iocp__event__loop_8c.html#ae809d5359ac030c60a30a8f0b2294b82">length</a>; ++i) {</div>
<div class="line">  <span class="keywordflow">if</span> <a class="code hl_variable" href="connection__state__test_8c.html#af7b550f3b3dbd60c52719a28b826fdd8">password</a>[i] != input[i] {</div>
<div class="line">    send(<span class="stringliteral">&quot;bad password&quot;</span>);</div>
<div class="line">  }</div>
<div class="line">}</div>
<div class="ttc" id="aconnection__state__test_8c_html_af7b550f3b3dbd60c52719a28b826fdd8"><div class="ttname"><a href="connection__state__test_8c.html#af7b550f3b3dbd60c52719a28b826fdd8">password</a></div><div class="ttdeci">struct aws_byte_cursor password</div><div class="ttdef"><b>Definition:</b> connection_state_test.c:623</div></div>
<div class="ttc" id="aiocp__event__loop_8c_html_ae809d5359ac030c60a30a8f0b2294b82"><div class="ttname"><a href="iocp__event__loop_8c.html#ae809d5359ac030c60a30a8f0b2294b82">length</a></div><div class="ttdeci">struct IO_STATUS_BLOCK void ULONG length</div><div class="ttdef"><b>Definition:</b> iocp_event_loop.c:49</div></div>
</div><!-- fragment --><p >then the amount of time until the reply message is received will depend on which byte in the password is incorrect. An attacker can simply guess</p>
<ul>
<li>a*******</li>
<li>b*******</li>
<li>c*******</li>
</ul>
<p >until the time to receive the error message changes, and then they know the first letter in the password. Repeating for the remaining characters turns an exponential guessing challenge into a linear one.</p>
<p >A variant of this attack, called LUCKY13, has been demonstrated against some implementations the Cipher Block Chaining (CBC) mode of SSL/TLS. In this attack, the TLS server is tricked into treating a (secret) encrypted byte as a padding length field. A naive TLS implementation will remove the specified amount of padding, then calculate a hash on the remaining bytes in the packet. If the value in the secret byte was large, a small number of bytes will be hashed; if it was small, a larger number of bytes will be hashed, creating a timing difference, which in theory can reveal the value in the secret byte.</p>
<p >For a detailed discussion of the LUCKY13 attack and how s2n mitigates against it, see <a href="https://aws.amazon.com/blogs/security/s2n-and-lucky-13/">this blog post</a>.</p>
<h1><a class="anchor" id="autotoc_md591"></a>
s2n countermeasures against timing side channels</h1>
<p >s2n takes a belt and suspenders approach to preventing side-channel attacks.</p><ol type="1">
<li>First of all, it uses code-balancing to ensure that the same number of hash compression rounds are processed, no matter the value in the secret byte.</li>
<li>Second, it adds a delay of up to 10 seconds whenever any error is triggered, which increases by orders of magnitude the number of timing samples an attacker would need, even if they found a way around countermeasure 1.</li>
</ol>
<h1><a class="anchor" id="autotoc_md592"></a>
Why use formal methods to prove the correctness of s2n's countermeasures?</h1>
<p >Side channels are notoriously difficult to defend against, since code with a side-channel has the same functional behaviour as code that is side-channel free. Testing can find bugs, but it cannot prove their absence. In order to prove the absence of a timing side-channel (up to a timing model of system execution), you need a formal proof.</p>
<p >Formal proofs are also useful because they help prevent regressions. If a code change causes a timing side-channel to be introduced, the proof will fail, and the developer will be notified before the bug goes to production.</p>
<h1><a class="anchor" id="autotoc_md593"></a>
How does SideTrail prove the correctness of code blinding countermeasures</h1>
<h2><a class="anchor" id="autotoc_md594"></a>
High level overview</h2>
<p >A program has a timing side channel if the amount of time needed to execute it depends on the value of a secret input to the program. SideTrail take a program, annotates every instruction with its runtime cost, and then generates a mathematical formula which symbolically represents the cost of executing the program given an input. SideTrail then asks an automated theorem prover, called a Satisfiability Modulo Theories (SMT) solver, if there is a pair of secret inputs to the program that would take different amounts of time to process. The SMT solver, using clever heuristics, exhaustively searches the state of all possible program inputs, and either returns a proof that there is no timing side-channel, or an example of a pair of inputs that lead to a timing channel, along with the estimated leakage.</p>
<h2><a class="anchor" id="autotoc_md595"></a>
User annotations</h2>
<p >In addition to the standard <code>assert()/assume()/</code> annotations supported through SMACK, there are several annotations supported by SideTrail, which allow the user to pass information to the SideTrail proof:</p>
<ol type="1">
<li><code>__VERIFIER_ASSUME_LEAKAGE(arg)</code>: When the timing-modeling transformation encounters this call, it increments the leakage tracking variables by "arg"</li>
<li><code><a class="el" href="sidetrail_2working_2stubs_2s2n__annotations_8h.html#a82b5a2764625cc3f652354d7ded65476">S2N_PUBLIC_INPUT(arg)</a></code>: the argument given here is taken to be public. All other variables are assumed private by default.</li>
<li><code><a class="el" href="sidetrail_2working_2stubs_2s2n__annotations_8h.html#a535b22580ac6790a65c3ad3baa8ff119">S2N_INVARIENT(arg)</a></code>: asserts that the given argument is an invariant of the loop, and as such holds on each execution of the loop, and at loop exit.</li>
<li><code>__VERIFIER_ASSERT_MAX_LEAKAGE(arg)</code>: asserts that the given function is time-balanced, with a leakage of less than "arg" time units.</li>
</ol>
<h2><a class="anchor" id="autotoc_md596"></a>
The gory details</h2>
<p >Mathematically, a program <code>P(secret, public)</code> has runtime <code>Time(P(secret,public))</code>. A program has a timing side-channel of delta if <code>|Time(P(secret_1,public)) - Time(P(secret_2,public))| = delta</code>. If we can represent <code>Time(P(secret,public))</code> as a mathematical formula, we can use a theorem prover to mathematically prove that the timing leakage of the program, for all choices of <code>secret_1, secret_2</code>, is less than <code>delta</code>.</p>
<p >SideTrail proceeds in several steps:</p>
<ol type="1">
<li>Compile the code to llvm bitcode - this allows SideTrail to accurately represent the effect of compiler optimizations on runtime</li>
<li>Use LLVM's timing model to associate every bitcode operation with a timing cost</li>
<li>Use SMACK to compile the annotated LLVM code to BoogiePL (this represents <code>(P(secret,public))</code> in the above formula</li>
<li>Use bam-bam-boogieman to<ul>
<li>Add a timing cost variable to the program, generating <code>Time(P(secret,public))</code></li>
<li>Make two copies of the resulting program, one which has inputs <code>(secret_1, public)</code>, the other of which has inputs <code>(secret_2, public)</code></li>
<li>Assert that the difference in time between the two programs is less than <code>delta</code></li>
</ul>
</li>
<li>Use boogie to prove (via the z3 theorem prover) that either<ul>
<li>The time is indeed less than <code>delta</code></li>
<li>or, the time is greater than <code>delta</code>, in which case the prover can emit a trace leading to the error</li>
</ul>
</li>
</ol>
<h1><a class="anchor" id="autotoc_md597"></a>
How to execute the tests</h1>
<h2><a class="anchor" id="autotoc_md598"></a>
Get Docker</h2>
<p >We assume you have docker installed and running on your machine. If not, follow the instructions to install it <a href="https://docs.docker.com/get-docker/">https://docs.docker.com/get-docker/</a></p>
<p >We will assume that you have a variable <code>$S2N</code> which encodes the path to s2n on your machine</p>
<div class="fragment"><div class="line">export S2N=&lt;path_to_s2n&gt;</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md599"></a>
Building the image</h2>
<p >To build the image, start with <code>s2n/codebuild/spec/sidetrail/Dockerfile</code></p>
<div class="fragment"><div class="line">cd $S2N</div>
<div class="line">docker build -f codebuild/spec/sidetrail/Dockerfile --tag sidetrail .</div>
</div><!-- fragment --><p >This step takes about 25 minutes on my laptop.</p>
<h2><a class="anchor" id="autotoc_md600"></a>
Starting docker</h2>
<div class="fragment"><div class="line">cd $S2N</div>
<div class="line">docker run -it -v `pwd`:/home/s2n --entrypoint /bin/bash sidetrail</div>
</div><!-- fragment --><p >You will now be presented with a docker shell. Inside this shell, run:</p>
<div class="fragment"><div class="line">source /sidetrail-install-dir/smack.environment </div>
</div><!-- fragment --><p >This step is important. If you do not source this file when you begin working, SideTrail may appear to run, but not actually analyze the code.</p>
<h2><a class="anchor" id="autotoc_md601"></a>
Running a proof inside docker</h2>
<div class="fragment"><div class="line">cd /home/s2n/tests/sidetrail/working</div>
<div class="line">cd &lt;testname&gt;</div>
<div class="line">./clean.sh ; ./run.sh</div>
</div><!-- fragment --><p >You should see output that looks something like this</p>
<div class="fragment"><div class="line">...</div>
<div class="line">...</div>
<div class="line">warning: memory intrinsic length exceeds threshold (0); adding quantifiers.</div>
<div class="line">SMACK generated s2n_record_parse_wrapper@s2n_record_read_wrapper.c.compiled.bpl</div>
<div class="line">warning: module contains undefined functions: malloc, __CONTRACT_invariant, nondet</div>
<div class="line"> </div>
<div class="line"> ____                _            _   </div>
<div class="line">|  _ \ _ __ ___   __| |_   _  ___| |_ </div>
<div class="line">| |_) | &#39;__/ _ \ / _` | | | |/ __| __|</div>
<div class="line">|  __/| | | (_) | (_| | |_| | (__| |_ </div>
<div class="line">|_|   |_|  \___/ \__,_|\__,_|\___|\__|</div>
<div class="line">                                      </div>
<div class="line">s2n_record_parse_wrapper@s2n_record_read_wrapper.c</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">__     __        _  __       </div>
<div class="line">\ \   / /__ _ __(_)/ _|_   _ </div>
<div class="line"> \ \ / / _ \ &#39;__| | |_| | | |</div>
<div class="line">  \ V /  __/ |  | |  _| |_| |</div>
<div class="line">   \_/ \___|_|  |_|_|  \__, |</div>
<div class="line">                       |___/ </div>
<div class="line">s2n_record_parse_wrapper@s2n_record_read_wrapper.c</div>
<div class="line"> </div>
<div class="line">+  boogie /printModel 4 /doModSetAnalysis s2n_record_parse_wrapper@s2n_record_read_wrapper.c.product.bpl</div>
<div class="line">Boogie program verifier version 2.3.0.61016, Copyright (c) 2003-2014, Microsoft.</div>
<div class="line"> </div>
<div class="line">Boogie program verifier finished with 1 verified, 0 errors</div>
<div class="line"> </div>
<div class="line">real    0m23.334s</div>
<div class="line">user    0m20.983s</div>
<div class="line">sys 0m2.395s</div>
</div><!-- fragment --><p >If you do not see the line,</p>
<div class="fragment"><div class="line">Boogie program verifier finished with 1 verified, 0 errors</div>
</div><!-- fragment --><p >then you probably forgot to source <code>smack.environment</code>. Go back and do so.</p>
<h1><a class="anchor" id="autotoc_md602"></a>
Debugging SideTrail failures</h1>
<p >Consult <a class="el" href="md_crt_aws_crt_cpp_crt_s2n_tests_sidetrail__d_e_b_u_g_g_i_n_g.html">the debugging guide</a>.</p>
<h1><a class="anchor" id="autotoc_md603"></a>
Questions?</h1>
<p >contact <a href="#" onclick="location.href='mai'+'lto:'+'aws'+'-a'+'rg-'+'pl'+'atf'+'or'+'ms-'+'su'+'ppo'+'rt'+'@am'+'az'+'on.'+'co'+'m'; return false;">aws-a<span style="display: none;">.nosp@m.</span>rg-p<span style="display: none;">.nosp@m.</span>latfo<span style="display: none;">.nosp@m.</span>rms-<span style="display: none;">.nosp@m.</span>suppo<span style="display: none;">.nosp@m.</span>rt@a<span style="display: none;">.nosp@m.</span>mazon<span style="display: none;">.nosp@m.</span>.com</a> </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.2
</small></address>
</body>
</html>
