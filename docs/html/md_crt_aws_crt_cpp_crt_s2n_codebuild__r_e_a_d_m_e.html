<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.2"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>AWS IoT Device SDK C++ v2: CodeBuild script info</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">AWS IoT Device SDK C++ v2<span id="projectnumber">&#160;1.14.0</span>
   </div>
   <div id="projectbrief">AWS IoT Device SDK C++ v2</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.2 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search",'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div><div class="header">
  <div class="headertitle"><div class="title">CodeBuild script info </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h3><a class="anchor" id="autotoc_md197"></a>
Design</h3>
<ul>
<li>How does CodeBuild decide what to install/test ? Historically the environment variables passed to the job dictate what is installed and which tests get run. CodeBuild has a pattern where environment variables can be over-ridden by CloudWatch events or batch jobs, so in some cases the CodeBuild job definition is generic or filled with placeholders (e.g. s2nFuzzScheduled).</li>
<li>Why not build docker images with the dependencies layered in ? This is the end goal: get tests running in CodeBuild first, then optimize the containers where it makes sense.</li>
</ul>
<h3><a class="anchor" id="autotoc_md198"></a>
Dep tree</h3>
<p >General flow of the CodeBuild Test Projects</p>
<ul>
<li>buildspec_{OS}.yml<ul>
<li>codebuild/install_default_dependencies.sh<ul>
<li>codebuild/install_clang.sh</li>
<li>codebuild/install_libFuzzer.sh</li>
<li>codebuild/install_openssl_1_1_1.sh</li>
<li>codebuild/install_openssl_1_0_2.sh</li>
<li>codebuild/install_openssl_1_0_2_fips.sh</li>
<li>codebuild/install_libressl.sh</li>
<li>codebuild/install_python.sh</li>
<li>codebuild/install_gnutls.sh</li>
<li>codebuild/install_saw.sh</li>
<li>codebuild/install_z3_yices.sh</li>
<li>codebuild/install_sslyze.sh</li>
</ul>
</li>
<li>codebuild/s2n_codebuild.sh<ul>
<li>codebuild/s2n_override_paths.sh</li>
<li>codebuild/copyright_mistake_scanner.sh</li>
<li>codebuild/run_kwstyle.sh</li>
<li>codebuild/cpp_style_comment_linter.sh</li>
<li>codebuild/run_ctverif.sh</li>
<li>codebuild/run_sidetrail.sh</li>
<li>codebuild/grep_simple_mistakes.sh</li>
</ul>
</li>
<li>codebuild/s2n_after_codebuild.sh<ul>
<li>curl -s <a href="https://codecov.io/bash">https://codecov.io/bash</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<h2><a class="anchor" id="autotoc_md199"></a>
Usage to setup Projects</h2>
<p >Using your favorite virtualenv, install the following dependencies: </p><div class="fragment"><div class="line">pip install -r requirements.txt</div>
</div><!-- fragment --><p >To bootstrap the CodeBuild jobs, the python script: </p><div class="fragment"><div class="line"># Verify your config is correct</div>
<div class="line">./create_project.py --config the-config-file.config</div>
<div class="line"> </div>
<div class="line"># If this is a new stack, commit the changes</div>
<div class="line">./create_project.py --config the-config-file.config --production</div>
<div class="line"> </div>
<div class="line"># If the stack already exists, then use a change set for the existing stack</div>
<div class="line">./create_project.py --config the-config-file.config --production --modify-existing</div>
</div><!-- fragment --><p >If you are modifying an existing stack then a list of changes will be displayed and you have the option to accept or reject that change set.</p>
<div class="fragment"><div class="line">ubuntu:codebuild/ $ ./create_project.py --config codebuild-integv2.config --production --modify-existing</div>
<div class="line">INFO:root:Wrote cfn yaml file to cfn/s2n_codebuild_projects.yml</div>
<div class="line">INFO:botocore.credentials:Found credentials in environment variables.</div>
<div class="line">INFO:root:CloudFormation template validation complete.</div>
<div class="line">INFO:root:Waiting for change set A2d385d4f0fcd217fff42e8a0cf3d51bd34a542e916524018b13176413410c2ab</div>
<div class="line">INFO:root:Summary of changes:</div>
<div class="line">    Action                   Modify</div>
<div class="line">    LogicalResourceId    s2nIntegrationV2OpenSSL111Gcc9Role</div>
<div class="line">    PhysicalResourceId   integv2s2nCodeBuildTests-s2nIntegrationV2OpenSSL11-161F84G7NJWVC</div>
<div class="line">    ResourceType         AWS::IAM::Role</div>
<div class="line">    Replacement               False</div>
<div class="line">    Scope                [&#39;Properties&#39;]</div>
<div class="line">    Details              [{&#39;Target&#39;: {&#39;Attribute&#39;: &#39;Properties&#39;, &#39;Name&#39;: &#39;Policies&#39;, &#39;RequiresRecreation&#39;: &#39;Never&#39;}, &#39;Evaluation&#39;: &#39;Static&#39;, &#39;ChangeSource&#39;: &#39;DirectModification&#39;}]</div>
<div class="line"> </div>
<div class="line">Do these changes make sense? [Y/n]Y</div>
<div class="line">INFO:root:Executing A2d385d4f0fcd217fff42e8a0cf3d51bd34a542e916524018b13176413410c2ab</div>
<div class="line">INFO:root:Update completed</div>
</div><!-- fragment --><ul>
<li>Use CloudFormation to create the stack with the generated template.</li>
<li>Open the CodeBuild projects in the console and setup the Source correctly, using your OTP credentials to connect to Github</li>
</ul>
<h2><a class="anchor" id="autotoc_md200"></a>
Words about CodeBuild instance size and concurrency</h2>
<p >The <a href="https://docs.aws.amazon.com/codebuild/latest/userguide/limits.html">AWS Codebuild</a> docs list the number of concurrent jobs at 60. With extensive testing, we've learned this number appears to be weighted based on <a href="https://docs.aws.amazon.com/codebuild/latest/userguide/build-env-ref-compute-types.html">instance size</a> (or provisioning limits), so running all tests on the largest possible instances will reduce actual concurrency. Additionally provisioning time is currently longer for larger instances, so there is a time penalty that might not be recovered by using a larger instance for short lived tests.</p>
<h2><a class="anchor" id="autotoc_md201"></a>
Batch Builds</h2>
<p >The <code>spec/buildspec_omnibus_batch.yml</code> contains a complete list of all CodeBuild jobs. In the future, this will replace the individual jobs created by the <a class="el" href="create__project_8py.html">create_project.py</a> script.</p>
<p >The broken out batch jobs: fuzz, integration and general, are created with the script create_batch.sh, which uses jq to parse out the jobs by title.</p>
<h2><a class="anchor" id="autotoc_md202"></a>
Notes on moving from Travis-ci</h2>
<ul>
<li>Install_clang from Travis is using google chromium clang commit from 2017- which requires python2.7 (EOL); updated for CodeBuild.</li>
<li>CodeBuild's environment is more restrictive than Travis- these jobs require elevated privilege to function.</li>
<li>Warning message from the fuzzer about test speed appear in CodeBuild output, but not in Travis-CI with the same test (See comments on AWS forums about a difference in ANSI TERM support); this also affects colorized output.</li>
<li>macOS/OSX platform files were not copied because CodeBuild does not support macOS builds.</li>
</ul>
<h2><a class="anchor" id="autotoc_md203"></a>
Querying CodeBuild projects</h2>
<p >Here is a sample of how to double check the size of the build hosts, as an example. AWS_ACCESS_KEY_ID and AWS_SECRET_ACCESS_KEY for an associated AWS account will need to be set for this to work, as well as a file called jobs, listing the names of all the CodeBuild jobs you'd like to check.</p>
<div class="fragment"><div class="line">for i in $(cat jobs); do echo -e &quot;$i\t&quot;;aws codebuild batch-get-projects --name &quot;$i&quot; |jq &#39;.projects[].environment.computeType&#39;; done</div>
</div><!-- fragment --> </div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.2
</small></address>
</body>
</html>
